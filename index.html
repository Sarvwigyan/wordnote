<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wordnote Pro Enhanced</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #2b5797;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-bg: #f8f9fa;
            --dark-text: #212529;
            --shadow: 0 0.25rem 0.9375rem rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
            --border-radius: 6px;
            --font-size: clamp(12px, 2.5vw, 14px);
            --screen-gap: clamp(5px, 1.5vw, 10px);
            --font-mono: 'JetBrains Mono', monospace;
            --font-ui: 'Segoe UI', system-ui, sans-serif;
            --menu-bg: linear-gradient(135deg, #ffffff, #f0f0f0);
            --dropdown-bg: #ffffff;
            --status-bg: #ffffff;
            --textarea-bg: #ffffff;
            --line-number-bg: #f8f9fa;
            --scrollbar-thumb: #6c757d;
            --scrollbar-track: #f8f9fa;
            --border-color: #dee2e6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-ui);
            background: var(--light-bg);
            color: var(--dark-text);
            height: 100vh;
            overflow: hidden;
            font-size: var(--font-size);
        }

        #container {
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            width: 100vw;
        }

        #menu-bar {
            background: var(--menu-bg);
            padding: clamp(0.3rem, 1vw, 0.75rem);
            display: flex;
            flex-wrap: wrap;
            gap: clamp(0.2rem, 0.8vw, 0.5rem);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            justify-content: flex-start;
            align-items: center;
        }

        .menu-btn {
            padding: clamp(0.3rem, 1vw, 0.6rem) clamp(0.6rem, 1.5vw, 1rem);
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: var(--border-radius);
            font-weight: 500;
            color: var(--dark-text);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: clamp(0.3rem, 0.8vw, 0.5rem);
            font-size: clamp(11px, 2vw, 14px);
            position: relative;
        }

        .menu-btn i {
            font-size: clamp(1em, 2.5vw, 1.2em);
        }

        .menu-btn:hover::after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

        .menu-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--primary-color);
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.3s ease-out;
        }

        .menu-btn:hover {
            background: #f1f3f5;
        }

        .menu-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .dropdown {
            position: fixed;
            background: var(--dropdown-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            width: clamp(120px, 20vw, 200px);
            box-shadow: var(--shadow);
            animation: slideIn 0.2s ease-out;
            z-index: 2000;
            max-height: clamp(200px, 60vh, 400px);
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            padding: 0.25rem 0;
        }

        .dropdown::-webkit-scrollbar {
            display: none;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dropdown-item {
            padding: clamp(0.4rem, 1vw, 0.7rem) clamp(0.6rem, 1.5vw, 1rem);
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            width: 100%;
            transition: var(--transition);
            color: var(--dark-text);
            font-size: clamp(10px, 2vw, 13px);
        }

        .dropdown-item:hover,
        .dropdown-item:focus {
            background: #e9ecef;
            color: var(--primary-color);
            outline: none;
        }

        .dropdown-item.submenu::after {
            content: '▶';
            float: right;
            font-size: clamp(7px, 1.5vw, 10px);
            transition: transform 0.2s ease;
        }

        .dropdown-item.submenu.active::after {
            transform: rotate(90deg);
        }

        .submenu-panel {
            position: fixed;
            background: var(--dropdown-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            width: clamp(120px, 20vw, 200px);
            box-shadow: var(--shadow);
            animation: slideIn 0.2s ease-out;
            z-index: 2001;
            display: none;
            max-height: clamp(200px, 50vh, 350px);
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            padding: 0.25rem 0;
        }

        .submenu-panel::-webkit-scrollbar {
            display: none;
        }

        #editor-container {
            display: flex;
            overflow: hidden;
            flex: 1;
            width: 100%;
            position: relative;
        }

        .split-view {
            display: flex;
            flex-direction: row;
            height: 100%;
        }

        .split-view.horizontal {
            flex-direction: column;
        }

        .split-view > .editor-pane {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
        }

        .line-numbers-container {
            width: clamp(25px, 4vw, 40px);
            background: var(--line-number-bg);
            color: #868e96;
            font-family: var(--font-mono);
            font-size: var(--font-size);
            text-align: right;
            padding: clamp(0.8rem, 1.5vw, 1.5rem) clamp(0.2rem, 0.8vw, 0.5rem);
            margin: var(--screen-gap) 0 var(--screen-gap) var(--screen-gap);
            overflow-y: hidden;
            user-select: none;
            z-index: 2;
            border-right: 1px solid var(--border-color);
            display: none;
            white-space: pre;
            line-height: 1.5;
        }

        textarea {
            flex: 1;
            padding: clamp(0.8rem, 1.5vw, 1.5rem);
            border: none;
            resize: none;
            font-family: var(--font-mono);
            font-size: var(--font-size);
            background: var(--textarea-bg);
            color: var(--dark-text);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            outline: none;
            transition: var(--transition);
            border-radius: var(--border-radius);
            margin: var(--screen-gap);
            line-height: 1.5;
            width: 100%;
            z-index: 3;
            position: relative;
        }

        textarea:focus {
            box-shadow: inset 0 0 0 2px var(--primary-color);
        }

        .highlight-layer {
            position: absolute;
            top: var(--screen-gap);
            left: clamp(25px, 4vw, 40px);
            right: var(--screen-gap);
            bottom: var(--screen-gap);
            padding: clamp(0.8rem, 1.5vw, 1.5rem);
            pointer-events: none;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            font-family: var(--font-mono);
            font-size: var(--font-size);
            line-height: 1.5;
            color: var(--dark-text);
            z-index: 1;
            opacity: 0.8;
        }

        .minimap-container {
            position: absolute;
            right: 0;
            top: var(--screen-gap);
            width: clamp(60px, 8vw, 100px);
            height: calc(100% - var(--screen-gap) * 2);
            background: rgba(248, 249, 250, 0.9);
            border-left: 1px solid var(--border-color);
            overflow: hidden;
            z-index: 3;
            display: none;
        }

        .minimap {
            width: 100%;
            transform-origin: top left;
            font-family: var(--font-mono);
            font-size: 2px;
            line-height: 1.5;
            color: #868e96;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }

        #status-bar {
            padding: clamp(0.3rem, 0.8vw, 0.7rem) clamp(0.5rem, 1.5vw, 1.5rem);
            background: var(--status-bg);
            border-top: 1px solid var(--border-color);
            font-size: clamp(9px, 1.8vw, 12px);
            color: #495057;
            display: flex;
            flex-wrap: wrap;
            gap: clamp(0.3rem, 1vw, 0.8rem);
            box-shadow: 0 -2px 5px rgba(0,0,0,0.03);
            align-items: center;
            justify-content: space-between;
            min-height: clamp(25px, 5vh, 40px);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: clamp(0.2rem, 0.8vw, 0.5rem);
            flex: 1 1 auto;
        }

        #auto-save-indicator {
            display: none;
            color: var(--success-color);
        }

        #settings-panel {
            position: fixed;
            right: -100%;
            top: 0;
            width: clamp(200px, 35vw, 350px);
            height: 100%;
            background: var(--light-bg);
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            transition: var(--transition);
            z-index: 1500;
            overflow-y: auto;
            padding: 0 clamp(0.5rem, 1vw, 1rem) clamp(0.5rem, 1vw, 1rem);
            border-radius: var(--border-radius) 0 0 var(--border-radius);
        }

        #settings-panel.active {
            right: 0;
        }

        .panel-header {
            padding: clamp(0.4rem, 1vw, 1rem);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--light-bg);
            z-index: 1;
        }

        .panel-header h2 {
            font-size: clamp(0.9rem, 2.2vw, 1.25rem);
        }

        #close-settings {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: clamp(0.3rem, 0.8vw, 0.5rem);
            font-size: clamp(1rem, 2.5vw, 1.25rem);
            color: var(--dark-text);
            transition: var(--transition);
        }

        #close-settings:hover {
            color: var(--primary-color);
        }

        .setting-group {
            margin: clamp(0.8rem, 1.5vw, 1.5rem) 0;
            padding: clamp(0.4rem, 0.8vw, 1rem);
            background: var(--line-number-bg);
            border-radius: var(--border-radius);
        }

        .setting-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: clamp(10px, 1.8vw, 13px);
        }

        select, input[type="number"], input[type="checkbox"], input[type="color"] {
            width: 100%;
            padding: clamp(0.3rem, 0.8vw, 0.5rem);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: clamp(10px, 1.8vw, 13px);
            transition: var(--transition);
        }

        input[type="checkbox"] {
            width: auto;
            margin-right: clamp(0.3rem, 0.8vw, 0.5rem);
        }

        select:hover, input[type="number"]:hover, input[type="color"]:hover {
            border-color: var(--primary-color);
        }

        select:focus, input[type="number"]:focus, input[type="color"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(43,87,151,0.3);
        }

        .btn-group {
            display: flex;
            gap: clamp(0.3rem, 0.8vw, 0.5rem);
            margin-top: clamp(0.8rem, 1.5vw, 1rem);
        }

        .btn {
            padding: clamp(0.4rem, 0.8vw, 0.5rem) clamp(0.8rem, 1.5vw, 1rem);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: clamp(10px, 1.8vw, 13px);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #21487a;
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #5c636a;
        }

        .dark-theme {
            --light-bg: #1a1a1a;
            --dark-text: #e0e0e0;
            --menu-bg: linear-gradient(135deg, #2d2d2d, #252525);
            --dropdown-bg: #2d2d2d;
            --status-bg: #252525;
            --textarea-bg: #1e1e1e;
            --line-number-bg: #252525;
            --scrollbar-thumb: #4d4d4d;
            --scrollbar-track: #2d2d2d;
            --border-color: #404040;
        }

        .solarized-theme {
            --light-bg: #fdf6e3;
            --dark-text: #657b83;
            --menu-bg: linear-gradient(135deg, #fdf6e3, #eee8d5);
            --dropdown-bg: #fdf6e3;
            --status-bg: #eee8d5;
            --textarea-bg: #fdf6e3;
            --line-number-bg: #eee8d5;
            --scrollbar-thumb: #93a1a1;
            --scrollbar-track: #eee8d5;
            --border-color: #93a1a1;
        }

        .dracula-theme {
            --light-bg: #282a36;
            --dark-text: #f8f8f2;
            --menu-bg: linear-gradient(135deg, #282a36, #21222c);
            --dropdown-bg: #282a36;
            --status-bg: #21222c;
            --textarea-bg: #282a36;
            --line-number-bg: #21222c;
            --scrollbar-thumb: #6272a4;
            --scrollbar-track: #282a36;
            --border-color: #6272a4;
        }

        @media (max-width: 1024px) {
            #menu-bar {
                padding: 0.4rem;
                gap: 0.3rem;
            }

            .menu-btn {
                padding: 0.4rem 0.8rem;
            }

            .dropdown, .submenu-panel {
                width: clamp(100px, 25vw, 180px);
                max-height: 50vh;
            }
        }

        @media (max-width: 768px) {
            #menu-bar {
                justify-content: center;
                padding: 0.3rem;
                gap: 0.2rem;
            }

            .menu-btn span {
                display: none;
            }

            .menu-btn {
                padding: 0.3rem 0.6rem;
            }

            .menu-btn i {
                font-size: 1.1em;
            }

            .dropdown {
                width: clamp(90px, 30vw, 150px);
                max-height: 40vh;
            }

            .submenu-panel {
                width: clamp(90px, 25vw, 150px);
                max-height: 35vh;
            }

            .line-numbers-container, .minimap-container {
                display: none !important;
            }

            .highlight-layer {
                left: var(--screen-gap);
            }

            textarea {
                margin-left: var(--screen-gap);
            }

            #status-bar {
                flex-direction: column;
                align-items: flex-start;
                padding: 0.4rem 0.8rem;
                gap: 0.3rem;
            }

            .status-item {
                flex: 0 1 auto;
            }

            #settings-panel {
                width: clamp(180px, 50vw, 300px);
            }
        }

        @media (max-width: 480px) {
            #menu-bar {
                padding: 0.2rem;
                gap: 0.1rem;
            }

            .menu-btn {
                padding: 0.2rem 0.4rem;
            }

            .dropdown {
                width: clamp(80px, 35vw, 120px);
                max-height: 30vh;
            }

            .submenu-panel {
                width: clamp(80px, 30vw, 120px);
                max-height: 25vh;
            }

            #status-bar {
                padding: 0.3rem 0.5rem;
                gap: 0.2rem;
            }

            #settings-panel {
                width: 100%;
                border-radius: 0;
            }

            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="container" role="application">
        <div id="menu-bar" role="menubar">
            <button class="menu-btn" id="file-btn" aria-label="File Menu" aria-haspopup="true"><i class="fas fa-file"></i><span>File</span></button>
            <button class="menu-btn" id="edit-btn" aria-label="Edit Menu" aria-haspopup="true"><i class="fas fa-edit"></i><span>Edit</span></button>
            <button class="menu-btn" id="format-btn" aria-label="Format Menu" aria-haspopup="true"><i class="fas fa-code"></i><span>Format</span></button>
            <button class="menu-btn" id="view-btn" aria-label="View Menu" aria-haspopup="true"><i class="fas fa-eye"></i><span>View</span></button>
            <button class="menu-btn" id="tools-btn" aria-label="Tools Menu" aria-haspopup="true"><i class="fas fa-tools"></i><span>Tools</span></button>
            <button class="menu-btn" id="insert-btn" aria-label="Insert Menu" aria-haspopup="true"><i class="fas fa-plus"></i><span>Insert</span></button>
            <button class="menu-btn" id="theme-toggle-btn" aria-label="Toggle Theme"><i class="fas fa-moon"></i><span>Toggle Theme</span></button>
            <button class="menu-btn" id="settings-btn" aria-label="Settings"><i class="fas fa-cog"></i><span>Settings</span></button>
            <div id="dropdown" class="dropdown" role="menu" style="display: none;" aria-hidden="true"></div>
        </div>

        <div id="editor-container" class="split-view" role="main">
            <div class="editor-pane" data-pane="main">
                <div class="line-numbers-container" aria-hidden="true"></div>
                <div class="highlight-layer" aria-hidden="true"></div>
                <textarea spellcheck="false" placeholder="Start typing..." aria-label="Text Editor"></textarea>
                <div class="minimap-container" aria-hidden="true">
                    <div class="minimap"></div>
                </div>
            </div>
        </div>

        <div id="status-bar" role="status">
            <span class="status-item"><i class="fas fa-file"></i><span id="cursor-pos">Ln 1, Col 1</span></span>
            <span class="status-item"><i class="fas fa-font"></i><span id="doc-stats">Words: 0 | Chars: 0</span></span>
            <span class="status-item"><i class="fas fa-weight"></i><span id="file-size">0 KB</span></span>
            <span class="status-item"><i class="fas fa-code"></i><span id="lang-mode">Plain Text</span></span>
            <span class="status-item"><i class="fas fa-wrap-text"></i><span id="wrap-status">Wrap: Off</span></span>
        </div>

        <div id="settings-panel" role="dialog" aria-labelledby="settings-title" aria-hidden="true">
            <div class="panel-header">
                <h2 id="settings-title">Settings</h2>
                <button id="close-settings" aria-label="Close Settings">×</button>
            </div>
            <div class="setting-group">
                <label for="font-family">Font Family</label>
                <select id="font-family" aria-label="Font Family">
                    <option value="JetBrains Mono">JetBrains Mono</option>
                    <option value="Fira Code">Fira Code</option>
                    <option value="Roboto Mono">Roboto Mono</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Source Code Pro">Source Code Pro</option>
                </select>
            </div>
            <div class="setting-group">
                <label for="font-size">Font Size</label>
                <input type="number" id="font-size" min="8" max="72" value="14" aria-label="Font Size">
            </div>
            <div class="setting-group">
                <label for="theme">Theme</label>
                <select id="theme" aria-label="Theme">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="solarized">Solarized</option>
                    <option value="dracula">Dracula</option>
                </select>
            </div>
            <div class="setting-group">
                <label for="text-color">Text Color</label>
                <input type="color" id="text-color" value="#212529" aria-label="Text Color">
            </div>
            <div class="setting-group">
                <label for="bg-color">Background Color</label>
                <input type="color" id="bg-color" value="#f8f9fa" aria-label="Background Color">
            </div>
            <div class="setting-group">
                <label><input type="checkbox" id="syntax-highlight" aria-label="Syntax Highlighting"> Syntax Highlighting</label>
            </div>
            <div class="setting-group">
                <label><input type="checkbox" id="line-numbers" aria-label="Line Numbers"> Line Numbers</label>
            </div>
            <div class="setting-group">
                <label><input type="checkbox" id="word-wrap" aria-label="Word Wrap"> Word Wrap</label>
            </div>
            <div class="setting-group">
                <label><input type="checkbox" id="minimap" aria-label="Minimap"> Minimap</label>
            </div>
            <div class="setting-group">
                <label for="language-mode">Language Mode</label>
                <select id="language-mode" aria-label="Language Mode">
                    <option value="plaintext">Plain Text</option>
                    <option value="javascript">JavaScript</option>
                    <option value="python">Python</option>
                    <option value="html">HTML</option>
                    <option value="css">CSS</option>
                    <option value="markdown">Markdown</option>
                </select>
            </div>
            <div class="setting-group">
                <label for="tab-size">Tab Size</label>
                <input type="number" id="tab-size" min="2" max="8" value="4" aria-label="Tab Size">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" id="save-settings" aria-label="Save Settings">Save</button>
                <button class="btn btn-secondary" id="reset-settings" aria-label="Reset Settings">Reset</button>
            </div>
        </div>
    </div>

    <script>
        class Minimap {
            constructor(pane) {
                this.pane = pane;
                this.textarea = pane.querySelector('textarea');
                this.minimapContainer = pane.querySelector('.minimap-container');
                this.minimap = pane.querySelector('.minimap');
                this.setup();
                this.updateThrottle = this.throttle(() => this.updateMinimap(), 100);
            }

            setup() {
                this.textarea.addEventListener('scroll', () => this.updateThrottle());
                this.textarea.addEventListener('input', () => this.updateThrottle());
                this.updateMinimap();
            }

            throttle(fn, wait) {
                let last = 0;
                return () => {
                    const now = Date.now();
                    if (now - last >= wait) {
                        fn();
                        last = now;
                    }
                };
            }

            updateMinimap() {
                try {
                    const content = this.textarea.value;
                    const lineHeight = 2;
                    const totalLines = content.split('\n').length;
                    const visibleHeight = this.pane.clientHeight;
                    const scale = Math.max(0.1, visibleHeight / (totalLines * lineHeight));
                    
                    this.minimap.textContent = content;
                    this.minimap.style.transform = `scaleY(${scale}) translateY(-${this.textarea.scrollTop / scale}px)`;
                    this.minimap.style.lineHeight = `${lineHeight}px`;
                } catch (error) {
                    console.error('Minimap update failed:', error);
                }
            }
        }

        class WordnotePro {
            constructor() {
                this.container = document.getElementById('editor-container');
                this.dropdown = document.getElementById('dropdown');
                this.panel = document.getElementById('settings-panel');
                this.history = {};
                this.redoStack = {};
                this.currentMenu = null;
                this.splitPanes = ['main'];
                this.minimaps = {};
                this.activePane = 'main';
                this.textarea = null;
                this.highlightLayer = null;
                this.lineNumberContainer = null;
                this.themes = {
                    light: '',
                    dark: 'dark-theme',
                    solarized: 'solarized-theme',
                    dracula: 'dracula-theme'
                };
                this.settings = {
                    fontFamily: 'JetBrains Mono',
                    fontSize: 14,
                    theme: 'light',
                    syntaxHighlight: false,
                    lineNumbers: false,
                    wordWrap: false,
                    minimap: false,
                    languageMode: 'plaintext',
                    tabSize: 4,
                    textColor: '#212529',
                    bgColor: '#f8f9fa'
                };

                this.setupInitialPane();
                this.menus = {
                    file: [
                        { text: 'New', action: () => this.newDocument(), shortcut: 'Ctrl+N' },
                        { text: 'Open', action: () => this.openFile(), shortcut: 'Ctrl+O' },
                        { text: 'Save', action: () => this.saveFile(), shortcut: 'Ctrl+S' },
                        { text: 'Save As', action: () => this.saveFileAs() },
                        { text: 'Export', submenu: [
                            { text: 'Markdown', action: () => this.exportMarkdown() },
                            { text: 'Text', action: () => this.saveFile() }
                        ]},
                        { text: 'Close', action: () => this.closeEditor() }
                    ],
                    edit: [
                        { text: 'Undo', action: () => this.undo(), shortcut: 'Ctrl+Z' },
                        { text: 'Redo', action: () => this.redo(), shortcut: 'Ctrl+Y' },
                        { text: 'Cut', action: () => this.cutText(), shortcut: 'Ctrl+X' },
                        { text: 'Copy', action: () => this.copyText(), shortcut: 'Ctrl+C' },
                        { text: 'Paste', action: () => this.pasteText(), shortcut: 'Ctrl+V' },
                        { text: 'Select All', action: () => this.selectAll(), shortcut: 'Ctrl+A' },
                        { text: 'Auto-Complete', action: () => this.autoComplete(), shortcut: 'Ctrl+Space' },
                        { text: 'Find/Replace', action: () => alert('Coming soon!'), shortcut: 'Ctrl+F' }
                    ],
                    format: [
                        { text: 'Word Wrap', action: () => this.toggleWordWrap() },
                        { text: 'To Uppercase', action: () => this.toUpperCase() },
                        { text: 'To Lowercase', action: () => this.toLowerCase() },
                        { text: 'Trim Whitespace', action: () => this.trimWhitespace() }
                    ],
                    view: [
                        { text: 'Full Screen', action: () => this.toggleFullScreen(), shortcut: 'F11' },
                        { text: 'Toggle Line Numbers', action: () => this.toggleLineNumbers() },
                        { text: 'Toggle Minimap', action: () => this.toggleMinimap() },
                        { text: 'Zoom In', action: () => this.zoom(2), shortcut: 'Ctrl+Plus' },
                        { text: 'Zoom Out', action: () => this.zoom(-2), shortcut: 'Ctrl+Minus' },
                        { text: 'Split View', submenu: [
                            { text: 'Horizontal', action: () => this.splitView('horizontal') },
                            { text: 'Vertical', action: () => this.splitView('vertical') },
                            { text: 'Remove Split', action: () => this.removeSplit() }
                        ]}
                    ],
                    tools: [
                        { text: 'Word Count', action: () => this.showWordCount() },
                        { text: 'Spell Check', action: () => this.toggleSpellCheck() },
                        { text: 'Character Map', action: () => this.showCharMap() }
                    ],
                    insert: [
                        { text: 'Current Date', action: () => this.insertDate() },
                        { text: 'Current Time', action: () => this.insertTime() },
                        { text: 'Special Characters', submenu: [
                            { text: 'Copyright ©', action: () => this.insertSpecialChar('©') },
                            { text: 'Registered ®', action: () => this.insertSpecialChar('®') },
                            { text: 'Trademark ™', action: () => this.insertSpecialChar('™') }
                        ]}
                    ]
                };

                this.init();
            }

            setupInitialPane() {
                const mainPane = this.container.querySelector('.editor-pane[data-pane="main"]');
                this.textarea = mainPane.querySelector('textarea');
                this.highlightLayer = mainPane.querySelector('.highlight-layer');
                this.lineNumberContainer = mainPane.querySelector('.line-numbers-container');
                this.history['main'] = [];
                this.redoStack['main'] = [];
                this.setupPaneEvents(mainPane);
                this.minimaps['main'] = new Minimap(mainPane);
            }

            init() {
                try {
                    this.loadSettings();
                    this.setupEventListeners();
                    this.applySettings();
                    this.updateStatus();
                    this.dropdown.style.display = 'none';
                    this.dropdown.setAttribute('aria-hidden', 'true');
                    window.addEventListener('resize', () => {
                        this.adjustDropdownPosition();
                        this.updateLineNumbers();
                        Object.values(this.minimaps).forEach(m => m.updateMinimap());
                    });
                } catch (error) {
                    console.error('Initialization failed:', error);
                    this.showNotification('Failed to initialize editor', 'error');
                }
            }

            setupEventListeners() {
                document.querySelectorAll('.menu-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (btn.id === 'settings-btn') {
                            this.togglePanel();
                        } else if (btn.id === 'theme-toggle-btn') {
                            this.toggleTheme();
                        } else {
                            this.toggleMenu(btn);
                        }
                    });
                });

                ['font-family', 'font-size', 'theme', 'language-mode', 'tab-size'].forEach(id => {
                    const element = document.getElementById(id);
                    element.addEventListener('change', e => {
                        this.settings[id.replace('-', '')] = e.target.type === 'number' ? parseInt(e.target.value) : e.target.value;
                        this.applySettings();
                        this.saveSettings();
                    });
                });

                ['syntax-highlight', 'line-numbers', 'word-wrap', 'minimap'].forEach(id => {
                    const element = document.getElementById(id);
                    element.addEventListener('change', e => {
                        this.settings[id.replace('-', '')] = e.target.checked;
                        this.applySettings();
                        this.saveSettings();
                    });
                });

                ['text-color', 'bg-color'].forEach(id => {
                    const input = document.getElementById(id);
                    input.addEventListener('change', e => {
                        this.settings[id.replace('-', '')] = e.target.value;
                        this.applySettings();
                        this.saveSettings();
                    });
                    input.addEventListener('input', e => {
                        this.settings[id.replace('-', '')] = e.target.value;
                        this.applySettings();
                    });
                });

                document.getElementById('save-settings').addEventListener('click', () => this.saveSettings());
                document.getElementById('reset-settings').addEventListener('click', () => this.resetSettings());
                document.getElementById('close-settings').addEventListener('click', () => this.togglePanel());

                this.textarea.addEventListener('touchstart', (e) => {
                    if (e.touches.length > 1) e.preventDefault();
                }, { passive: false });

                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === '/') {
                        this.showKeyboardShortcuts();
                    }
                });
            }

            setupPaneEvents(pane) {
                const textarea = pane.querySelector('textarea');
                const highlightLayer = pane.querySelector('.highlight-layer');
                const lineNumberContainer = pane.querySelector('.line-numbers-container');
                const paneId = pane.dataset.pane;

                textarea.addEventListener('input', () => {
                    this.activePane = paneId;
                    this.textarea = textarea;
                    this.highlightLayer = highlightLayer;
                    this.lineNumberContainer = lineNumberContainer;
                    this.handleInput();
                });
                textarea.addEventListener('keydown', e => this.handleKeydown(e));
                textarea.addEventListener('click', () => {
                    this.activePane = paneId;
                    this.textarea = textarea;
                    this.highlightLayer = highlightLayer;
                    this.lineNumberContainer = lineNumberContainer;
                    this.updateStatus();
                });
                textarea.addEventListener('scroll', () => this.syncLineNumbersScroll());
            }

            toggleMenu(button) {
                if (this.currentMenu === button.id) {
                    this.hideDropdown();
                } else {
                    this.showDropdown(button.id.replace('-btn', ''), button);
                    this.currentMenu = button.id;
                }
            }

            adjustDropdownPosition(dropdown = this.dropdown, button) {
                if (!button) return;
                const rect = button.getBoundingClientRect();
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                const dropdownWidth = dropdown.offsetWidth || 150;
                const dropdownHeight = dropdown.offsetHeight || 200;
                const screenGap = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--screen-gap'));

                let left = rect.left;
                let top = rect.bottom;

                if (left + dropdownWidth > screenWidth - screenGap) {
                    left = screenWidth - dropdownWidth - screenGap;
                }
                if (left < screenGap) left = screenGap;

                if (top + dropdownHeight > screenHeight - screenGap) {
                    top = rect.top - dropdownHeight - screenGap;
                    if (top < screenGap) {
                        top = screenGap;
                        dropdown.style.maxHeight = `${screenHeight - screenGap * 2 - rect.height}px`;
                    }
                }

                dropdown.style.left = `${left}px`;
                dropdown.style.top = `${top}px`;

                dropdown.querySelectorAll('.submenu-panel').forEach(submenu => {
                    const parentRect = submenu.parentElement.getBoundingClientRect();
                    const submenuWidth = submenu.offsetWidth || 150;
                    const submenuHeight = submenu.offsetHeight || 150;
                    let submenuLeft, submenuTop = parentRect.top;

                    const spaceRight = screenWidth - parentRect.right - screenGap;
                    const spaceLeft = parentRect.left - screenGap;

                    if (spaceRight >= submenuWidth && screenWidth >= 768) {
                        submenuLeft = parentRect.right + 5;
                    } else if (spaceLeft >= submenuWidth) {
                        submenuLeft = parentRect.left - submenuWidth - 5;
                    } else {
                        submenuLeft = screenWidth >= 768 ? 
                            parentRect.right + 5 : 
                            screenGap;
                        submenu.style.maxWidth = `${Math.min(spaceRight, parentRect.left - screenGap - 5)}px`;
                    }

                    if (submenuLeft + submenuWidth > screenWidth - screenGap) {
                        submenuLeft = screenWidth - submenuWidth - screenGap;
                    }
                    if (submenuLeft < screenGap) submenuLeft = screenGap;

                    if (submenuTop + submenuHeight > screenHeight - screenGap) {
                        submenuTop = screenHeight - submenuHeight - screenGap;
                        if (submenuTop < screenGap) {
                            submenuTop = screenGap;
                            submenu.style.maxHeight = `${screenHeight - screenGap * 2}px`;
                        }
                    }

                    submenu.style.left = `${submenuLeft}px`;
                    submenu.style.top = `${submenuTop}px`;
                });
            }

            showDropdown(menu, button) {
                this.hideDropdown();
                this.dropdown.style.display = 'block';
                this.dropdown.setAttribute('aria-hidden', 'false');
                button.classList.add('active');
                this.dropdown.innerHTML = '';

                this.menus[menu].forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'dropdown-item';
                    btn.setAttribute('role', 'menuitem');
                    btn.innerHTML = item.shortcut 
                        ? `${item.text} <span style="float: right; opacity: 0.7">${item.shortcut}</span>`
                        : item.text;

                    if (item.submenu) {
                        btn.classList.add('submenu');
                        btn.setAttribute('aria-haspopup', 'true');
                        const submenuPanel = document.createElement('div');
                        submenuPanel.className = 'submenu-panel';
                        submenuPanel.setAttribute('role', 'menu');

                        item.submenu.forEach(subItem => {
                            const subBtn = document.createElement('button');
                            subBtn.className = 'dropdown-item';
                            subBtn.setAttribute('role', 'menuitem');
                            subBtn.textContent = subItem.text;
                            subBtn.addEventListener('click', () => {
                                subItem.action();
                                this.hideDropdown();
                            });
                            submenuPanel.appendChild(subBtn);
                        });

                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const isOpen = submenuPanel.style.display === 'block';
                            document.querySelectorAll('.submenu-panel').forEach(p => p.style.display = 'none');
                            document.querySelectorAll('.dropdown-item.submenu').forEach(b => b.classList.remove('active'));
                            if (!isOpen) {
                                submenuPanel.style.display = 'block';
                                btn.classList.add('active');
                                this.adjustDropdownPosition(this.dropdown, button);
                            }
                        });

                        btn.appendChild(submenuPanel);
                    } else {
                        btn.addEventListener('click', () => {
                            item.action();
                            this.hideDropdown();
                        });
                    }
                    this.dropdown.appendChild(btn);
                });

                this.adjustDropdownPosition(this.dropdown, button);
            }

            hideDropdown() {
                this.dropdown.style.display = 'none';
                this.dropdown.setAttribute('aria-hidden', 'true');
                document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.submenu-panel').forEach(p => p.style.display = 'none');
                document.querySelectorAll('.dropdown-item.submenu').forEach(b => b.classList.remove('active'));
                this.currentMenu = null;
            }

            newDocument() {
                if (this.textarea.value && confirm('Discard current document?')) {
                    this.textarea.value = '';
                    this.history[this.activePane] = [];
                    this.redoStack[this.activePane] = [];
                    this.updateStatus();
                    this.applySyntaxHighlight();
                    this.updateLineNumbers();
                    this.minimaps[this.activePane].updateMinimap();
                }
            }

            async openFile() {
                try {
                    if ('showOpenFilePicker' in window) {
                        const [fileHandle] = await window.showOpenFilePicker();
                        const file = await fileHandle.getFile();
                        const text = await file.text();
                        this.textarea.value = text;
                        this.history[this.activePane] = [text];
                        this.redoStack[this.activePane] = [];
                        this.detectLanguage(file.name);
                        this.updateAll();
                        this.showNotification('File opened successfully', 'success');
                    } else {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.txt,.md,.js,.html,.css';
                        input.onchange = e => {
                            const file = e.target.files[0];
                            const reader = new FileReader();
                            reader.onload = e => {
                                this.textarea.value = e.target.result;
                                this.history[this.activePane] = [e.target.result];
                                this.redoStack[this.activePane] = [];
                                this.updateStatus();
                                this.applySyntaxHighlight();
                                this.updateLineNumbers();
                                this.detectLanguage(file.name);
                                this.minimaps[this.activePane].updateMinimap();
                                this.showNotification('File opened successfully', 'success');
                            };
                            reader.onerror = () => this.showNotification('Error reading file', 'error');
                            reader.readAsText(file);
                        };
                        input.click();
                    }
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('File open error:', err);
                        this.showNotification('Error opening file: ' + err.message, 'error');
                    }
                }
            }

            async saveFile() {
                try {
                    const blob = new Blob([this.textarea.value], { type: 'text/plain' });
                    if ('showSaveFilePicker' in window) {
                        const fileHandle = await window.showSaveFilePicker({
                            suggestedName: 'document.txt',
                            types: [{
                                description: 'Text Files',
                                accept: { 'text/plain': ['.txt'] }
                            }]
                        });
                        const writable = await fileHandle.createWritable();
                        await writable.write(blob);
                        await writable.close();
                        this.showNotification('File saved successfully', 'success');
                    } else {
                        this.downloadFile(blob, 'document.txt');
                        this.showNotification('File saved successfully', 'success');
                    }
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('File save error:', err);
                        this.showNotification('Error saving file: ' + err.message, 'error');
                    }
                }
            }

            saveFileAs() {
                const name = prompt('Enter file name:', 'document.txt');
                if (name) {
                    try {
                        const blob = new Blob([this.textarea.value], { type: 'text/plain' });
                        this.downloadFile(blob, name);
                        this.showNotification('File saved as ' + name, 'success');
                    } catch (err) {
                        console.error('Save as error:', err);
                        this.showNotification('Error saving file: ' + err.message, 'error');
                    }
                }
            }

            exportMarkdown() {
                try {
                    const blob = new Blob([this.textarea.value], { type: 'text/markdown' });
                    this.downloadFile(blob, 'document.md');
                    this.showNotification('Exported as Markdown', 'success');
                } catch (err) {
                    console.error('Markdown export error:', err);
                    this.showNotification('Error exporting as Markdown: ' + err.message, 'error');
                }
            }

            downloadFile(blob, name) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = name;
                a.click();
                URL.revokeObjectURL(url);
            }

            undo() {
                if (this.history[this.activePane].length > 1) {
                    this.redoStack[this.activePane].push(this.history[this.activePane].pop());
                    this.textarea.value = this.history[this.activePane][this.history[this.activePane].length - 1] || '';
                    this.updateStatus();
                    this.applySyntaxHighlight();
                    this.updateLineNumbers();
                    this.minimaps[this.activePane].updateMinimap();
                }
            }

            redo() {
                if (this.redoStack[this.activePane].length > 0) {
                    const text = this.redoStack[this.activePane].pop();
                    this.history[this.activePane].push(text);
                    this.textarea.value = text;
                    this.updateStatus();
                    this.applySyntaxHighlight();
                    this.updateLineNumbers();
                    this.minimaps[this.activePane].updateMinimap();
                }
            }

            cutText() {
                try {
                    navigator.clipboard.writeText(this.textarea.value.substring(this.textarea.selectionStart, this.textarea.selectionEnd));
                    this.textarea.setRangeText('');
                    this.history[this.activePane].push(this.textarea.value);
                    this.updateStatus();
                    this.applySyntaxHighlight();
                    this.updateLineNumbers();
                    this.minimaps[this.activePane].updateMinimap();
                } catch (err) {
                    console.error('Cut error:', err);
                    this.showNotification('Error cutting text', 'error');
                }
            }

            copyText() {
                try {
                    navigator.clipboard.writeText(this.textarea.value.substring(this.textarea.selectionStart, this.textarea.selectionEnd));
                } catch (err) {
                    console.error('Copy error:', err);
                    this.showNotification('Error copying text', 'error');
                }
            }

            pasteText() {
                try {
                    navigator.clipboard.readText().then(text => {
                        this.textarea.setRangeText(text);
                        this.history[this.activePane].push(this.textarea.value);
                        this.updateStatus();
                        this.applySyntaxHighlight();
                        this.updateLineNumbers();
                        this.minimaps[this.activePane].updateMinimap();
                    });
                } catch (err) {
                    console.error('Paste error:', err);
                    this.showNotification('Error pasting text', 'error');
                }
            }

            selectAll() {
                this.textarea.select();
                this.updateStatus();
            }

            autoComplete() {
                const languageRules = {
                    javascript: ['if', 'else', 'function', 'const', 'let', 'var', 'return'],
                    python: ['def', 'if', 'else', 'elif', 'for', 'while', 'import'],
                    html: ['div', 'span', 'p', 'a', 'img'],
                    css: ['color', 'background', 'margin', 'padding'],
                    markdown: ['#', '##', '###']
                };
                const suggestions = languageRules[this.settings.languageMode] || [];
                const cursorPos = this.textarea.selectionStart;
                const textBefore = this.textarea.value.substring(0, cursorPos);
                const lastWord = textBefore.split(/\s+/).pop();
                const match = suggestions.find(s => s.startsWith(lastWord));
                if (match) {
                    this.textarea.setRangeText(match, cursorPos - lastWord.length, cursorPos);
                    this.history[this.activePane].push(this.textarea.value);
                    this.updateStatus();
                    this.applySyntaxHighlight();
                    this.updateLineNumbers();
                    this.minimaps[this.activePane].updateMinimap();
                }
            }

            toggleWordWrap() {
                this.settings.wordWrap = !this.settings.wordWrap;
                document.getElementById('word-wrap').checked = this.settings.wordWrap;
                this.applySettings();
                this.saveSettings();
                document.getElementById('wrap-status').textContent = `Wrap: ${this.settings.wordWrap ? 'On' : 'Off'}`;
            }

            toggleFullScreen() {
                try {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen();
                    } else {
                        document.exitFullscreen();
                    }
                } catch (err) {
                    console.error('Fullscreen error:', err);
                    this.showNotification('Error toggling fullscreen', 'error');
                }
            }

            toggleTheme() {
                this.settings.theme = this.settings.theme === 'light' ? 'dark' : 'light';
                document.getElementById('theme').value = this.settings.theme;
                this.applySettings();
                this.saveSettings();
            }

            zoom(factor) {
                this.settings.fontSize = Math.max(8, Math.min(72, this.settings.fontSize + factor));
                document.getElementById('font-size').value = this.settings.fontSize;
                document.documentElement.style.setProperty('--font-size', `clamp(${this.settings.fontSize - 2}px, 2.5vw, ${this.settings.fontSize}px)`);
                this.applySettings();
                this.saveSettings();
            }

            toggleLineNumbers() {
                this.settings.lineNumbers = !this.settings.lineNumbers;
                document.getElementById('line-numbers').checked = this.settings.lineNumbers;
                this.applySettings();
                this.saveSettings();
            }

            toggleMinimap() {
                this.settings.minimap = !this.settings.minimap;
                document.getElementById('minimap').checked = this.settings.minimap;
                this.applySettings();
                this.saveSettings();
            }

            splitView(direction) {
                if (this.splitPanes.length >= 2) return alert('Only one split allowed');
                const newPaneId = `pane-${Date.now()}`;
                this.splitPanes.push(newPaneId);
                this.history[newPaneId] = [];
                this.redoStack[newPaneId] = [];
                this.container.className = `split-view ${direction}`;
                const newPane = document.createElement('div');
                newPane.className = 'editor-pane';
                newPane.dataset.pane = newPaneId;
                newPane.innerHTML = `
                    <div class="line-numbers-container" aria-hidden="true"></div>
                    <div class="highlight-layer" aria-hidden="true"></div>
                    <textarea spellcheck="false" placeholder="Start typing..." aria-label="Text Editor"></textarea>
                    <div class="minimap-container" aria-hidden="true">
                        <div class="minimap"></div>
                    </div>
                `;
                this.container.appendChild(newPane);
                const newTextarea = newPane.querySelector('textarea');
                newTextarea.value = this.textarea.value;
                this.setupPaneEvents(newPane);
                this.minimaps[newPaneId] = new Minimap(newPane);
                this.applySettings();
            }

            removeSplit() {
                if (this.splitPanes.length <= 1) return;
                const removedPane = this.splitPanes.pop();
                const paneElement = this.container.querySelector(`.editor-pane[data-pane="${removedPane}"]`);
                paneElement.remove();
                delete this.history[removedPane];
                delete this.redoStack[removedPane];
                delete this.minimaps[removedPane];
                this.container.className = 'split-view';
                this.activePane = 'main';
                const mainPane = this.container.querySelector('.editor-pane[data-pane="main"]');
                this.textarea = mainPane.querySelector('textarea');
                this.highlightLayer = mainPane.querySelector('.highlight-layer');
                this.lineNumberContainer = mainPane.querySelector('.line-numbers-container');
                this.applySettings();
            }

            showWordCount() {
                const words = this.textarea.value.trim().split(/\s+/).filter(w => w).length;
                alert(`Word Count: ${words}`);
            }

            toggleSpellCheck() {
                this.textarea.spellcheck = !this.textarea.spellcheck;
            }

            toUpperCase() {
                const start = this.textarea.selectionStart;
                const end = this.textarea.selectionEnd;
                this.textarea.setRangeText(this.textarea.value.substring(start, end).toUpperCase());
                this.history[this.activePane].push(this.textarea.value);
                this.updateStatus();
                this.minimaps[this.activePane].updateMinimap();
            }

            toLowerCase() {
                const start = this.textarea.selectionStart;
                const end = this.textarea.selectionEnd;
                this.textarea.setRangeText(this.textarea.value.substring(start, end).toLowerCase());
                this.history[this.activePane].push(this.textarea.value);
                this.updateStatus();
                this.minimaps[this.activePane].updateMinimap();
            }

            trimWhitespace() {
                this.textarea.value = this.textarea.value.trim();
                this.history[this.activePane].push(this.textarea.value);
                this.updateStatus();
                this.applySyntaxHighlight();
                this.updateLineNumbers();
                this.minimaps[this.activePane].updateMinimap();
            }

            insertDate() {
                const date = new Date().toLocaleDateString();
                this.textarea.setRangeText(date);
                this.history[this.activePane].push(this.textarea.value);
                this.updateStatus();
                this.minimaps[this.activePane].updateMinimap();
            }

            insertTime() {
                const time = new Date().toLocaleTimeString();
                this.textarea.setRangeText(time);
                this.history[this.activePane].push(this.textarea.value);
                this.updateStatus();
                this.minimaps[this.activePane].updateMinimap();
            }

            insertSpecialChar(char) {
                this.textarea.setRangeText(char);
                this.history[this.activePane].push(this.textarea.value);
                this.updateStatus();
                this.minimaps[this.activePane].updateMinimap();
            }

            showCharMap() {
                alert('Character Map: Coming soon!');
            }

            togglePanel() {
                const isActive = this.panel.classList.toggle('active');
                this.panel.setAttribute('aria-hidden', !isActive);
            }

            closeEditor() {
                if (confirm('Are you sure you want to close?')) {
                    window.close();
                }
            }

            resetSettings() {
                if (confirm('Reset all settings?')) {
                    this.settings = {
                        fontFamily: 'JetBrains Mono',
                        fontSize: 14,
                        theme: 'light',
                        syntaxHighlight: false,
                        lineNumbers: false,
                        wordWrap: false,
                        minimap: false,
                        languageMode: 'plaintext',
                        tabSize: 4,
                        textColor: '#212529',
                        bgColor: '#f8f9fa'
                    };
                    document.documentElement.style.setProperty('--font-size', 'clamp(12px, 2.5vw, 14px)');
                    this.updateSettingsUI();
                    this.applySettings();
                    localStorage.removeItem('wordnoteSettings');
                }
            }

            saveSettings() {
                localStorage.setItem('wordnoteSettings', JSON.stringify(this.settings));
            }

            loadSettings() {
                const saved = localStorage.getItem('wordnoteSettings');
                if (saved) {
                    this.settings = JSON.parse(saved);
                    document.documentElement.style.setProperty('--font-size', `clamp(${this.settings.fontSize - 2}px, 2.5vw, ${this.settings.fontSize}px)`);
                    this.updateSettingsUI();
                }
            }

            updateSettingsUI() {
                document.getElementById('font-family').value = this.settings.fontFamily;
                document.getElementById('font-size').value = this.settings.fontSize;
                document.getElementById('theme').value = this.settings.theme;
                document.getElementById('syntax-highlight').checked = this.settings.syntaxHighlight;
                document.getElementById('line-numbers').checked = this.settings.lineNumbers;
                document.getElementById('word-wrap').checked = this.settings.wordWrap;
                document.getElementById('minimap').checked = this.settings.minimap;
                document.getElementById('language-mode').value = this.settings.languageMode;
                document.getElementById('tab-size').value = this.settings.tabSize;
                document.getElementById('text-color').value = this.settings.textColor;
                document.getElementById('bg-color').value = this.settings.bgColor;
            }

            handleInput() {
                this.history[this.activePane].push(this.textarea.value);
                if (this.history[this.activePane].length > 50) this.history[this.activePane].shift();
                this.redoStack[this.activePane] = [];
                this.updateStatus();
                if (this.settings.syntaxHighlight) {
                    this.applySyntaxHighlight();
                }
                this.updateLineNumbers();
                this.minimaps[this.activePane].updateMinimap();
            }

            handleKeydown(e) {
                if (e.ctrlKey) {
                    switch (e.key) {
                        case 's': e.preventDefault(); this.saveFile(); break;
                        case 'o': e.preventDefault(); this.openFile(); break;
                        case 'n': e.preventDefault(); this.newDocument(); break;
                        case 'z': e.preventDefault(); this.undo(); break;
                        case 'y': e.preventDefault(); this.redo(); break;
                        case '+': e.preventDefault(); this.zoom(2); break;
                        case '-': e.preventDefault(); this.zoom(-2); break;
                        case 'a': e.preventDefault(); this.selectAll(); break;
                        case ' ': e.preventDefault(); this.autoComplete(); break;
                    }
                } else if (e.key === 'F11') {
                    e.preventDefault();
                    this.toggleFullScreen();
                } else if (e.key === 'Tab') {
                    e.preventDefault();
                    this.textarea.setRangeText(' '.repeat(this.settings.tabSize));
                    this.history[this.activePane].push(this.textarea.value);
                    this.updateStatus();
                    this.minimaps[this.activePane].updateMinimap();
                }
            }

            updateStatus() {
                const text = this.textarea.value || '';
                const lines = text.split('\n');
                const cursorPos = this.textarea.selectionStart;
                const words = text.trim().split(/\s+/).filter(w => w).length;
                const chars = text.length;
                const sizeKB = (text.length / 1024).toFixed(2);
                let line = 1;
                let col = 1;

                for (let i = 0; i < cursorPos; i++) {
                    if (text[i] === '\n') {
                        line++;
                        col = 1;
                    } else {
                        col++;
                    }
                }

                document.getElementById('cursor-pos').textContent = `Ln ${line}, Col ${col}`;
                document.getElementById('doc-stats').textContent = `Words: ${words} | Chars: ${chars}`;
                document.getElementById('file-size').textContent = `${sizeKB} KB`;
                document.getElementById('lang-mode').textContent = this.settings.languageMode.charAt(0).toUpperCase() + this.settings.languageMode.slice(1);
                document.getElementById('wrap-status').textContent = `Wrap: ${this.settings.wordWrap ? 'On' : 'Off'}`;
            }

            applySettings() {
                const panes = this.container.querySelectorAll('.editor-pane');
                panes.forEach(pane => {
                    const textarea = pane.querySelector('textarea');
                    const highlightLayer = pane.querySelector('.highlight-layer');
                    const lineNumberContainer = pane.querySelector('.line-numbers-container');
                    const minimapContainer = pane.querySelector('.minimap-container');

                    textarea.style.fontFamily = this.settings.fontFamily;
                    textarea.style.fontSize = `${this.settings.fontSize}px`;
                    textarea.style.color = this.settings.textColor;
                    textarea.style.backgroundColor = this.settings.bgColor;
                    textarea.style.whiteSpace = this.settings.wordWrap ? 'pre-wrap' : 'pre';
                    highlightLayer.style.fontFamily = this.settings.fontFamily;
                    highlightLayer.style.fontSize = `${this.settings.fontSize}px`;
                    highlightLayer.style.color = this.settings.syntaxHighlight ? 'transparent' : this.settings.textColor;
                    highlightLayer.style.backgroundColor = 'transparent';
                    highlightLayer.style.whiteSpace = this.settings.wordWrap ? 'pre-wrap' : 'pre';
                    lineNumberContainer.style.fontFamily = this.settings.fontFamily;
                    lineNumberContainer.style.fontSize = `${this.settings.fontSize}px`;
                    lineNumberContainer.style.display = this.settings.lineNumbers && window.innerWidth > 768 ? 'block' : 'none';
                    minimapContainer.style.display = this.settings.minimap && window.innerWidth > 768 ? 'block' : 'none';
                    highlightLayer.style.left = this.settings.lineNumbers && window.innerWidth > 768 ? 'clamp(25px, 4vw, 40px)' : 'var(--screen-gap)';
                    textarea.style.marginLeft = this.settings.lineNumbers && window.innerWidth > 768 ? '0' : 'var(--screen-gap)';
                });

                this.applyTheme();
                this.updateLineNumbers();
                if (this.settings.syntaxHighlight) {
                    this.applySyntaxHighlight();
                } else {
                    this.highlightLayer.innerHTML = '';
                    this.textarea.style.color = this.settings.textColor;
                }
            }

            applyTheme() {
                document.body.className = this.themes[this.settings.theme] || '';
                const themeColors = {
                    light: {
                        '--light-bg': this.settings.bgColor,
                        '--dark-text': this.settings.textColor
                    },
                    dark: {
                        '--light-bg': '#1a1a1a',
                        '--dark-text': '#e0e0e0'
                    },
                    solarized: {
                        '--light-bg': '#fdf6e3',
                        '--dark-text': '#657b83'
                    },
                    dracula: {
                        '--light-bg': '#282a36',
                        '--dark-text': '#f8f8f2'
                    }
                };

                const colors = themeColors[this.settings.theme] || themeColors.light;
                Object.entries(colors).forEach(([key, value]) => {
                    document.documentElement.style.setProperty(key, value);
                });
            }

            applySyntaxHighlight() {
                if (!this.settings.syntaxHighlight) {
                    this.highlightLayer.innerHTML = '';
                    this.textarea.style.color = this.settings.textColor;
                    return;
                }

                this.debouncedHighlight();
            }

            debouncedHighlight = this.debounce(() => {
                const languageRules = {
                    javascript: {
                        keywords: ['function', 'const', 'let', 'var', 'if', 'else', 'return', 'for', 'while', 'class'],
                        keywordColor: '#0078d4',
                        stringColor: '#e6c07b',
                        commentColor: '#6a737d',
                        numberColor: '#d19a66'
                    },
                    python: {
                        keywords: ['def', 'class', 'if', 'else', 'elif', 'for', 'while', 'return', 'import'],
                        keywordColor: '#3572A5',
                        stringColor: '#e6db74',
                        commentColor: '#75715e',
                        numberColor: '#d19a66'
                    },
                    html: {
                        keywords: ['<!DOCTYPE', '<html', '<head', '<body', '<div', '<span'],
                        keywordColor: '#e34c26',
                        stringColor: '#032f62',
                        commentColor: '#969896',
                        numberColor: '#d19a66'
                    },
                    css: {
                        keywords: ['color', 'background', 'margin', 'padding', 'font'],
                        keywordColor: '#563d7c',
                        stringColor: '#e6c07b',
                        commentColor: '#6a737d',
                        numberColor: '#d19a66'
                    },
                    markdown: {
                        keywords: ['#', '##', '###'],
                        keywordColor: '#d73a49',
                        stringColor: '#032f62',
                        commentColor: '#6a737d',
                        numberColor: '#d19a66'
                    }
                };

                const rules = languageRules[this.settings.languageMode] || {};
                const keywords = rules.keywords || [];
                const strings = /(["'`])(?:(?=(\\?))\2.)*?\1/g;
                const comments = /(\/\/.*$|\/\*[\s\S]*?\*\/)/gm;
                const numbers = /\b\d+\b/g;

                let content = this.textarea.value
                    .replace(/&/g, '&')
                    .replace(/</g, '<')
                    .replace(/>/g, '>');

                content = content
                    .replace(comments, match => `<span style="color: ${rules.commentColor || '#6a737d'}">${match}</span>`)
                    .replace(strings, match => `<span style="color: ${rules.stringColor || '#e6c07b'}">${match}</span>`)
                    .replace(numbers, match => `<span style="color: ${rules.numberColor || '#d19a66'}">${match}</span>`)
                    .replace(new RegExp(`\\b(${keywords.join('|')})\\b`, 'g'), 
                        match => `<span style="color: ${rules.keywordColor || '#0078d4'}">${match}</span>`);

                this.highlightLayer.innerHTML = content;
                this.textarea.style.color = 'transparent';
                this.textarea.style.caretColor = this.settings.textColor;
            }, 300);

            debounce(fn, delay) {
                let timeout;
                return () => {
                    clearTimeout(timeout);
                    timeout = setTimeout(fn, delay);
                };
            }

            detectLanguage(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const extMap = {
                    'js': 'javascript',
                    'py': 'python',
                    'html': 'html',
                    'css': 'css',
                    'md': 'markdown',
                    'txt': 'plaintext'
                };
                this.settings.languageMode = extMap[ext] || 'plaintext';
                document.getElementById('language-mode').value = this.settings.languageMode;
                this.applySettings();
                this.saveSettings();
            }

            updateLineNumbers() {
                const lines = this.textarea.value.split('\n');
                const numbers = lines.map((_, i) => i + 1).join('\n');
                this.lineNumberContainer.textContent = numbers;
                const computedStyle = window.getComputedStyle(this.textarea);
                this.lineNumberContainer.style.lineHeight = computedStyle.lineHeight;
                this.lineNumberContainer.style.fontSize = computedStyle.fontSize;
            }

            syncLineNumbersScroll() {
                this.lineNumberContainer.scrollTop = this.textarea.scrollTop;
                this.highlightLayer.scrollTop = this.textarea.scrollTop;
            }

            updateAll() {
                this.updateStatus();
                this.applySyntaxHighlight();
                this.updateLineNumbers();
                this.minimaps[this.activePane].updateMinimap();
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('show');
                    setTimeout(() => {
                        notification.classList.remove('show');
                        setTimeout(() => notification.remove(), 300);
                    }, 3000);
                }, 100);
            }

            showKeyboardShortcuts() {
                const shortcuts = [
                    { key: 'Ctrl+S', action: 'Save' },
                    { key: 'Ctrl+O', action: 'Open' },
                    { key: 'Ctrl+N', action: 'New' },
                    { key: 'Ctrl+Z/Y', action: 'Undo/Redo' },
                    { key: 'F11', action: 'Fullscreen' },
                    { key: 'Ctrl+/', action: 'Show Help' }
                ];

                const helpText = shortcuts.map(s => `${s.key}: ${s.action}`).join('\n');
                alert('Keyboard Shortcuts:\n\n' + helpText);
            }
        }

        const notificationStyle = document.createElement('style');
        notificationStyle.textContent = `
            .notification {
                position: fixed;
                bottom: clamp(15px, 2vh, 20px);
                right: -300px;
                padding: clamp(8px, 1.5vw, 12px) clamp(16px, 2vw, 24px);
                border-radius: var(--border-radius);
                background: var(--light-bg);
                color: var(--dark-text);
                box-shadow: var(--shadow);
                transition: var(--transition);
                z-index: 3000;
                border: 1px solid var(--border-color);
                font-size: clamp(10px, 1.8vw, 14px);
            }
            
            .notification.show {
                right: clamp(15px, 2vw, 20px);
            }
            
            .notification.success {
                background: var(--success-color);
                color: white;
            }
            
            .notification.error {
                background: var(--danger-color);
                color: white;
            }
        `;
        document.head.appendChild(notificationStyle);

        const editor = new WordnotePro();
        document.body.addEventListener('click', e => {
            if (!e.target.closest('.menu-btn') && !e.target.closest('.dropdown') && !e.target.closest('#settings-panel')) {
                editor.hideDropdown();
            }
        });
    </script>
</body>
</html>