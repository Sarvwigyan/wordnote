<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wordnote Pro Enhanced</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #2b5797;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-bg: #f8f9fa;
            --dark-text: #212529;
            --shadow: 0 0.25rem 0.9375rem rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
            --border-radius: 6px;
            --font-size: clamp(12px, 2.5vw, 14px);
            --screen-gap: clamp(5px, 2vw, 10px);
            --font-mono: 'JetBrains Mono', monospace;
            --font-ui: 'Segoe UI', system-ui, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5c636a;
        }

        body {
            font-family: var(--font-ui);
            background: var(--light-bg);
            color: var(--dark-text);
            height: 100vh;
            overflow: hidden;
            font-size: var(--font-size);
        }

        #container {
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            width: 100%;
        }

        #menu-bar {
            background: linear-gradient(135deg, #ffffff, #f0f0f0);
            padding: clamp(0.5rem, 1vw, 0.75rem);
            display: flex;
            flex-wrap: wrap;
            gap: clamp(0.25rem, 1vw, 0.5rem);
            border-bottom: 1px solid #dee2e6;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .menu-btn {
            padding: clamp(0.4rem, 1.5vw, 0.6rem) clamp(0.8rem, 2vw, 1rem);
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: var(--border-radius);
            font-weight: 500;
            color: var(--dark-text);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: clamp(12px, 2vw, 14px);
            position: relative;
        }

        .menu-btn i {
            font-size: 1.2em;
        }

        .menu-btn:hover::after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

        .menu-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--primary-color);
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.3s ease-out;
        }

        .menu-btn:hover {
            background: #f1f3f5;
        }

        .menu-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .dropdown {
            position: fixed;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            min-width: clamp(150px, 20vw, 200px);
            box-shadow: var(--shadow);
            animation: slideIn 0.2s ease-out;
            z-index: 2000;
            max-height: calc(100vh - var(--screen-gap) * 2);
            overflow-y: auto;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dropdown-item {
            padding: clamp(0.5rem, 1.5vw, 0.7rem) clamp(0.8rem, 2vw, 1rem);
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            width: 100%;
            transition: var(--transition);
            color: var(--dark-text);
            font-size: clamp(11px, 2vw, 13px);
        }

        .dropdown-item:hover,
        .dropdown-item:focus {
            background: #e9ecef;
            color: var(--primary-color);
            outline: none;
        }

        .dropdown-item.submenu::after {
            content: 'â–¶';
            float: right;
            font-size: clamp(8px, 1.5vw, 10px);
            transition: transform 0.2s ease;
        }

        .dropdown-item.submenu.active::after {
            transform: rotate(90deg);
        }

        .submenu-panel {
            position: fixed;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            min-width: clamp(150px, 25vw, 200px);
            box-shadow: var(--shadow);
            animation: slideIn 0.2s ease-out;
            z-index: 2001;
            display: none;
            max-height: calc(100vh - var(--screen-gap) * 2);
            overflow-y: auto;
        }

        #editor-container {
            display: flex;
            overflow: hidden;
            flex: 1;
            width: 100%;
            position: relative;
        }

        .split-view {
            display: flex;
            flex-direction: row;
            height: 100%;
        }

        .split-view.horizontal {
            flex-direction: column;
        }

        .split-view > .editor-pane {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
        }

        .line-numbers-container {
            width: clamp(30px, 5vw, 40px);
            background: #f8f9fa;
            color: #868e96;
            font-family: var(--font-mono);
            font-size: var(--font-size);
            text-align: right;
            padding: clamp(1rem, 2vw, 1.5rem) clamp(0.3rem, 1vw, 0.5rem);
            margin: var(--screen-gap) 0 var(--screen-gap) var(--screen-gap);
            overflow-y: auto;
            user-select: none;
            z-index: 2;
            border-right: 1px solid #dee2e6;
            display: none;
        }

        textarea {
            flex: 1;
            padding: clamp(1rem, 2vw, 1.5rem);
            border: none;
            resize: none;
            font-family: var(--font-mono);
            font-size: var(--font-size);
            background: white;
            color: var(--dark-text);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            outline: none;
            transition: var(--transition);
            border-radius: var(--border-radius);
            margin: var(--screen-gap);
            line-height: 1.5;
            width: 100%;
            z-index: 3;
            position: relative;
        }

        textarea:focus {
            box-shadow: inset 0 0 0 2px var(--primary-color);
        }

        .highlight-layer {
            position: absolute;
            top: var(--screen-gap);
            left: clamp(30px, 5vw, 40px);
            right: var(--screen-gap);
            bottom: var(--screen-gap);
            padding: clamp(1rem, 2vw, 1.5rem);
            pointer-events: none;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            font-family: var(--font-mono);
            font-size: var(--font-size);
            line-height: 1.5;
            color: var(--dark-text);
            z-index: 1;
            opacity: 0.8;
        }

        .minimap-container {
            position: absolute;
            right: 0;
            top: var(--screen-gap);
            width: clamp(80px, 10vw, 100px);
            height: calc(100% - var(--screen-gap) * 2);
            background: rgba(248, 249, 250, 0.9);
            border-left: 1px solid #dee2e6;
            overflow: hidden;
            z-index: 3;
            display: none;
        }

        .minimap {
            width: 100%;
            transform-origin: top left;
            font-family: var(--font-mono);
            font-size: 2px;
            line-height: 1.5;
            color: #868e96;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }

        #status-bar {
            padding: clamp(0.4rem, 1vw, 0.7rem) clamp(1rem, 2vw, 1.5rem);
            background: white;
            border-top: 1px solid #dee2e6;
            font-size: clamp(10px, 2vw, 12px);
            color: #495057;
            display: flex;
            justify-content: space-between;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.03);
            flex-wrap: wrap;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #auto-save-indicator {
            display: none;
            color: var(--success-color);
        }

        #auto-save-indicator.active {
            display: inline-block;
        }

        #settings-panel {
            position: fixed;
            right: -100%;
            top: 0;
            width: clamp(250px, 40vw, 350px);
            height: 100%;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            transition: var(--transition);
            z-index: 1500;
            overflow-y: auto;
            padding: clamp(0.5rem, 1vw, 1rem);
            border-radius: var(--border-radius) 0 0 var(--border-radius);
        }

        #settings-panel.active {
            right: 0;
        }

        .panel-header {
            padding: clamp(0.5rem, 1vw, 1rem);
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }

        .panel-header h2 {
            font-size: clamp(1rem, 2.5vw, 1.25rem);
        }

        #close-settings {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            font-size: 1.25rem;
            color: var(--dark-text);
            transition: var(--transition);
        }

        #close-settings:hover {
            color: var(--primary-color);
        }

        .setting-group {
            margin: clamp(1rem, 2vw, 1.5rem) 0;
            padding: clamp(0.5rem, 1vw, 1rem);
            background: #f8f9fa;
            border-radius: var(--border-radius);
        }

        .setting-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: clamp(11px, 2vw, 13px);
        }

        select, input[type="number"], input[type="checkbox"], input[type="color"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: clamp(11px, 2vw, 13px);
            transition: var(--transition);
        }

        input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
        }

        select:hover, input[type="number"]:hover, input[type="color"]:hover {
            border-color: var(--primary-color);
        }

        select:focus, input[type="number"]:focus, input[type="color"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(43,87,151,0.3);
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: clamp(11px, 2vw, 13px);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #21487a;
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #5c636a;
        }

        @media (max-width: 768px) {
            #menu-bar {
                justify-content: center;
                gap: 0.25rem;
                padding: 0.5rem;
            }

            .menu-btn span {
                display: none;
            }

            .line-numbers-container, .minimap-container {
                display: none !important;
            }

            .highlight-layer {
                left: var(--screen-gap);
            }

            textarea {
                margin-left: var(--screen-gap);
            }

            #status-bar {
                flex-direction: column;
                text-align: center;
                gap: 0.5rem;
            }

            #settings-panel {
                width: 80%;
            }
        }

        @media (max-width: 480px) {
            #settings-panel {
                width: 100%;
                border-radius: 0;
            }

            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="menu-bar">
            <button class="menu-btn" id="file-btn"><i class="fas fa-file"></i><span>File</span></button>
            <button class="menu-btn" id="edit-btn"><i class="fas fa-edit"></i><span>Edit</span></button>
            <button class="menu-btn" id="format-btn"><i class="fas fa-code"></i><span>Format</span></button>
            <button class="menu-btn" id="view-btn"><i class="fas fa-eye"></i><span>View</span></button>
            <button class="menu-btn" id="tools-btn"><i class="fas fa-tools"></i><span>Tools</span></button>
            <button class="menu-btn" id="insert-btn"><i class="fas fa-plus"></i><span>Insert</span></button>
            <button class="menu-btn" id="theme-toggle-btn"><i class="fas fa-moon"></i><span>Toggle Theme</span></button>
            <button class="menu-btn" id="settings-btn"><i class="fas fa-cog"></i><span>Settings</span></button>
            <div id="dropdown" class="dropdown" style="display: none;"></div>
        </div>

        <div id="editor-container" class="split-view">
            <div class="editor-pane" data-pane="main">
                <div class="line-numbers-container"></div>
                <div class="highlight-layer"></div>
                <textarea spellcheck="false" placeholder="Start typing..."></textarea>
                <div class="minimap-container">
                    <div class="minimap"></div>
                </div>
            </div>
        </div>

        <div id="status-bar">
            <span class="status-item"><i class="fas fa-file"></i><span id="cursor-pos">Ln 1, Col 1</span></span>
            <span class="status-item"><i class="fas fa-font"></i><span id="doc-stats">Words: 0 | Chars: 0</span></span>
            <span class="status-item"><i class="fas fa-weight"></i><span id="file-size">0 KB</span></span>
            <span class="status-item"><i class="fas fa-code"></i><span id="lang-mode">Plain Text</span></span>
            <span class="status-item"><i class="fas fa-wrap-text"></i><span id="wrap-status">Wrap: Off</span></span>
            <span class="status-item"><i class="fas fa-save"></i><span id="auto-save-indicator">Saving...</span></span>
        </div>

        <div id="settings-panel">
            <div class="panel-header">
                <h2>Settings</h2>
                <button id="close-settings">Ã—</button>
            </div>
            <div class="setting-group">
                <label for="font-family">Font Family</label>
                <select id="font-family">
                    <option value="JetBrains Mono">JetBrains Mono</option>
                    <option value="Fira Code">Fira Code</option>
                    <option value="Roboto Mono">Roboto Mono</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Source Code Pro">Source Code Pro</option>
                </select>
            </div>
            <div class="setting-group">
                <label for="font-size">Font Size</label>
                <input type="number" id="font-size" min="8" max="72" value="14">
            </div>
            <div class="setting-group">
                <label for="theme">Theme</label>
                <select id="theme">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="solarized">Solarized</option>
                    <option value="dracula">Dracula</option>
                </select>
            </div>
            <div class="setting-group">
                <label for="text-color">Text Color</label>
                <input type="color" id="text-color" value="#212529">
            </div>
            <div class="setting-group">
                <label for="bg-color">Background Color</label>
                <input type="color" id="bg-color" value="#f8f9fa">
            </div>
            <div class="setting-group">
                <label><input type="checkbox" id="syntax-highlight"> Syntax Highlighting</label>
            </div>
            <div class="setting-group">
                <label><input type="checkbox" id="auto-save"> Auto Save</label>
            </div>
            <div class="setting-group">
                <label><input type="checkbox" id="line-numbers"> Line Numbers</label>
            </div>
            <div class="setting-group">
                <label><input type="checkbox" id="word-wrap"> Word Wrap</label>
            </div>
            <div class="setting-group">
                <label><input type="checkbox" id="minimap"> Minimap</label>
            </div>
            <div class="setting-group">
                <label for="language-mode">Language Mode</label>
                <select id="language-mode">
                    <option value="plaintext">Plain Text</option>
                    <option value="javascript">JavaScript</option>
                    <option value="python">Python</option>
                    <option value="html">HTML</option>
                    <option value="css">CSS</option>
                    <option value="markdown">Markdown</option>
                </select>
            </div>
            <div class="setting-group">
                <label for="tab-size">Tab Size</label>
                <input type="number" id="tab-size" min="2" max="8" value="4">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" id="save-settings">Save</button>
                <button class="btn btn-secondary" id="reset-settings">Reset</button>
            </div>
        </div>
    </div>

    <script>
        class Minimap {
            constructor(pane) {
                this.pane = pane;
                this.textarea = pane.querySelector('textarea');
                this.minimapContainer = pane.querySelector('.minimap-container');
                this.minimap = pane.querySelector('.minimap');
                this.setup();
            }

            setup() {
                this.textarea.addEventListener('scroll', () => this.updateMinimap());
                this.textarea.addEventListener('input', () => this.updateMinimap());
                this.updateMinimap();
            }

            updateMinimap() {
                const content = this.textarea.value;
                this.minimap.textContent = content;
                const scale = this.pane.clientHeight / (content.split('\n').length * 1.5 * 2);
                this.minimap.style.transform = `scaleY(${scale}) translateY(-${this.textarea.scrollTop / scale}px)`;
            }
        }

        class WordnotePro {
            constructor() {
                this.container = document.getElementById('editor-container');
                this.dropdown = document.getElementById('dropdown');
                this.panel = document.getElementById('settings-panel');
                this.statusIndicator = document.getElementById('auto-save-indicator');
                this.history = {};
                this.redoStack = {};
                this.currentMenu = null;
                this.splitPanes = ['main'];
                this.minimaps = {};
                this.activePane = 'main';
                this.textarea = null;
                this.highlightLayer = null;
                this.lineNumberContainer = null;
                this.settings = {
                    fontFamily: 'JetBrains Mono',
                    fontSize: 14,
                    theme: 'light',
                    syntaxHighlight: false,
                    autoSave: false,
                    lineNumbers: false,
                    wordWrap: false,
                    minimap: false,
                    languageMode: 'plaintext',
                    tabSize: 4,
                    textColor: '#212529',
                    bgColor: '#f8f9fa'
                };

                this.setupInitialPane();
                this.menus = {
                    file: [
                        { text: 'New', action: () => this.newDocument(), shortcut: 'Ctrl+N' },
                        { text: 'Open', action: () => this.openFile(), shortcut: 'Ctrl+O' },
                        { text: 'Save', action: () => this.saveFile(), shortcut: 'Ctrl+S' },
                        { text: 'Save As', action: () => this.saveFileAs() },
                        { text: 'Export', submenu: [
                            { text: 'Markdown', action: () => this.exportMarkdown() },
                            { text: 'Text', action: () => this.saveFile() }
                        ]},
                        { text: 'Close', action: () => this.closeEditor() }
                    ],
                    edit: [
                        { text: 'Undo', action: () => this.undo(), shortcut: 'Ctrl+Z' },
                        { text: 'Redo', action: () => this.redo(), shortcut: 'Ctrl+Y' },
                        { text: 'Cut', action: () => this.cutText(), shortcut: 'Ctrl+X' },
                        { text: 'Copy', action: () => this.copyText(), shortcut: 'Ctrl+C' },
                        { text: 'Paste', action: () => this.pasteText(), shortcut: 'Ctrl+V' },
                        { text: 'Select All', action: () => this.selectAll(), shortcut: 'Ctrl+A' },
                        { text: 'Auto-Complete', action: () => this.autoComplete(), shortcut: 'Ctrl+Space' },
                        { text: 'Find/Replace', action: () => alert('Coming soon!'), shortcut: 'Ctrl+F' }
                    ],
                    format: [
                        { text: 'Word Wrap', action: () => this.toggleWordWrap() },
                        { text: 'To Uppercase', action: () => this.toUpperCase() },
                        { text: 'To Lowercase', action: () => this.toLowerCase() },
                        { text: 'Trim Whitespace', action: () => this.trimWhitespace() }
                    ],
                    view: [
                        { text: 'Full Screen', action: () => this.toggleFullScreen(), shortcut: 'F11' },
                        { text: 'Toggle Line Numbers', action: () => this.toggleLineNumbers() },
                        { text: 'Toggle Minimap', action: () => this.toggleMinimap() },
                        { text: 'Zoom In', action: () => this.zoom(2), shortcut: 'Ctrl+Plus' },
                        { text: 'Zoom Out', action: () => this.zoom(-2), shortcut: 'Ctrl+Minus' },
                        { text: 'Split View', submenu: [
                            { text: 'Horizontal', action: () => this.splitView('horizontal') },
                            { text: 'Vertical', action: () => this.splitView('vertical') },
                            { text: 'Remove Split', action: () => this.removeSplit() }
                        ]}
                    ],
                    tools: [
                        { text: 'Word Count', action: () => this.showWordCount() },
                        { text: 'Spell Check', action: () => this.toggleSpellCheck() },
                        { text: 'Character Map', action: () => this.showCharMap() }
                    ],
                    insert: [
                        { text: 'Current Date', action: () => this.insertDate() },
                        { text: 'Current Time', action: () => this.insertTime() },
                        { text: 'Special Characters', submenu: [
                            { text: 'Copyright Â©', action: () => this.insertSpecialChar('Â©') },
                            { text: 'Registered Â®', action: () => this.insertSpecialChar('Â®') },
                            { text: 'Trademark â„¢', action: () => this.insertSpecialChar('â„¢') }
                        ]}
                    ]
                };

                this.init();
            }

            setupInitialPane() {
                const mainPane = this.container.querySelector('.editor-pane[data-pane="main"]');
                this.textarea = mainPane.querySelector('textarea');
                this.highlightLayer = mainPane.querySelector('.highlight-layer');
                this.lineNumberContainer = mainPane.querySelector('.line-numbers-container');
                this.history['main'] = [];
                this.redoStack['main'] = [];
                this.setupPaneEvents(mainPane);
                this.minimaps['main'] = new Minimap(mainPane);
            }

            init() {
                this.loadSettings();
                this.setupEventListeners();
                this.applySettings();
                this.updateStatus();
                this.dropdown.style.display = 'none';
                window.addEventListener('resize', () => {
                    this.adjustDropdownPosition();
                    this.updateLineNumbers();
                    Object.values(this.minimaps).forEach(m => m.updateMinimap());
                });
                setInterval(() => this.autoSave(), 30000);
            }

            setupEventListeners() {
                document.querySelectorAll('.menu-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (btn.id === 'settings-btn') {
                            this.togglePanel();
                        } else if (btn.id === 'theme-toggle-btn') {
                            this.toggleTheme();
                        } else {
                            this.toggleMenu(btn);
                        }
                    });
                });

                ['font-family', 'font-size', 'theme', 'language-mode', 'tab-size'].forEach(id => {
                    document.getElementById(id).addEventListener('change', e => {
                        this.settings[id.replace('-', '')] = e.target.type === 'number' ? parseInt(e.target.value) : e.target.value;
                        this.applySettings();
                        this.saveSettings();
                    });
                });

                ['syntax-highlight', 'auto-save', 'line-numbers', 'word-wrap', 'minimap'].forEach(id => {
                    document.getElementById(id).addEventListener('change', e => {
                        this.settings[id.replace('-', '')] = e.target.checked;
                        this.applySettings();
                        this.saveSettings();
                    });
                });

                ['text-color', 'bg-color'].forEach(id => {
                    document.getElementById(id).addEventListener('change', e => {
                        this.settings[id.replace('-', '')] = e.target.value;
                        this.applySettings();
                        this.saveSettings();
                    });
                });

                document.getElementById('save-settings').addEventListener('click', () => this.saveSettings());
                document.getElementById('reset-settings').addEventListener('click', () => this.resetSettings());
                document.getElementById('close-settings').addEventListener('click', () => this.togglePanel());
            }

            setupPaneEvents(pane) {
                const textarea = pane.querySelector('textarea');
                const highlightLayer = pane.querySelector('.highlight-layer');
                const lineNumberContainer = pane.querySelector('.line-numbers-container');
                const paneId = pane.dataset.pane;

                textarea.addEventListener('input', () => {
                    this.activePane = paneId;
                    this.textarea = textarea;
                    this.highlightLayer = highlightLayer;
                    this.lineNumberContainer = lineNumberContainer;
                    this.handleInput();
                });
                textarea.addEventListener('keydown', e => this.handleKeydown(e));
                textarea.addEventListener('click', () => {
                    this.activePane = paneId;
                    this.textarea = textarea;
                    this.highlightLayer = highlightLayer;
                    this.lineNumberContainer = lineNumberContainer;
                    this.updateStatus();
                });
                textarea.addEventListener('scroll', () => this.syncLineNumbersScroll());
            }

            toggleMenu(button) {
                if (this.currentMenu === button.id) {
                    this.hideDropdown();
                } else {
                    this.showDropdown(button.id.replace('-btn', ''), button);
                    this.currentMenu = button.id;
                }
            }

            adjustDropdownPosition(dropdown = this.dropdown, button) {
                if (!button) return;
                const rect = button.getBoundingClientRect();
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                const dropdownWidth = dropdown.offsetWidth || 200; // Fallback width
                const dropdownHeight = dropdown.offsetHeight || 200; // Fallback height
                const screenGap = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--screen-gap'));

                // Position main dropdown
                let left = rect.left;
                let top = rect.bottom;

                if (left + dropdownWidth > screenWidth - screenGap) {
                    left = screenWidth - dropdownWidth - screenGap;
                }
                if (left < screenGap) left = screenGap;

                if (top + dropdownHeight > screenHeight - screenGap) {
                    top = rect.top - dropdownHeight - screenGap;
                    if (top < screenGap) {
                        top = screenGap;
                        dropdown.style.maxHeight = `${screenHeight - screenGap * 2}px`;
                    }
                }

                dropdown.style.left = `${left}px`;
                dropdown.style.top = `${top}px`;

                // Adjust submenus
                dropdown.querySelectorAll('.submenu-panel').forEach(submenu => {
                    const parentRect = submenu.parentElement.getBoundingClientRect();
                    const submenuWidth = submenu.offsetWidth || 150; // Fallback width
                    const submenuHeight = submenu.offsetHeight || 150; // Fallback height
                    let submenuLeft, submenuTop = parentRect.top;

                    // Calculate available space on both sides
                    const spaceRight = screenWidth - parentRect.right - screenGap;
                    const spaceLeft = parentRect.left - screenGap;

                    // Decide submenu direction based on available space
                    if (spaceRight >= submenuWidth && screenWidth >= 768) {
                        // Open to the right if there's enough space and not on small screens
                        submenuLeft = parentRect.right + 5;
                    } else if (spaceLeft >= submenuWidth) {
                        // Open to the left if there's enough space on the left
                        submenuLeft = parentRect.left - submenuWidth - 5;
                    } else {
                        // If neither side has enough space, position it at the best edge and constrain width
                        if (spaceRight > spaceLeft) {
                            submenuLeft = parentRect.right + 5;
                            submenu.style.maxWidth = `${spaceRight}px`;
                        } else {
                            submenuLeft = screenGap;
                            submenu.style.maxWidth = `${parentRect.left - screenGap - 5}px`;
                        }
                    }

                    // Ensure submenu stays within horizontal bounds
                    if (submenuLeft + submenuWidth > screenWidth - screenGap) {
                        submenuLeft = screenWidth - submenuWidth - screenGap;
                    }
                    if (submenuLeft < screenGap) {
                        submenuLeft = screenGap;
                        submenu.style.maxWidth = `${screenWidth - screenGap * 2}px`;
                    }

                    // Adjust submenu vertically
                    if (submenuTop + submenuHeight > screenHeight - screenGap) {
                        submenuTop = screenHeight - submenuHeight - screenGap;
                        if (submenuTop < screenGap) {
                            submenuTop = screenGap;
                            submenu.style.maxHeight = `${screenHeight - screenGap * 2}px`;
                        }
                    }

                    submenu.style.left = `${submenuLeft}px`;
                    submenu.style.top = `${submenuTop}px`;
                });
            }

            showDropdown(menu, button) {
                this.hideDropdown();
                this.dropdown.style.display = 'block';
                button.classList.add('active');
                this.dropdown.innerHTML = '';

                this.menus[menu].forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'dropdown-item';
                    btn.innerHTML = item.shortcut 
                        ? `${item.text} <span style="float: right; opacity: 0.7">${item.shortcut}</span>`
                        : item.text;

                    if (item.submenu) {
                        btn.classList.add('submenu');
                        const submenuPanel = document.createElement('div');
                        submenuPanel.className = 'submenu-panel';

                        item.submenu.forEach(subItem => {
                            const subBtn = document.createElement('button');
                            subBtn.className = 'dropdown-item';
                            subBtn.textContent = subItem.text;
                            subBtn.addEventListener('click', () => {
                                subItem.action();
                                this.hideDropdown();
                            });
                            submenuPanel.appendChild(subBtn);
                        });

                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const isOpen = submenuPanel.style.display === 'block';
                            document.querySelectorAll('.submenu-panel').forEach(p => p.style.display = 'none');
                            document.querySelectorAll('.dropdown-item.submenu').forEach(b => b.classList.remove('active'));
                            if (!isOpen) {
                                submenuPanel.style.display = 'block';
                                btn.classList.add('active');
                                this.adjustDropdownPosition(this.dropdown, button);
                            }
                        });

                        btn.appendChild(submenuPanel);
                    } else {
                        btn.addEventListener('click', () => {
                            item.action();
                            this.hideDropdown();
                        });
                    }
                    this.dropdown.appendChild(btn);
                });

                this.adjustDropdownPosition(this.dropdown, button);
            }

            hideDropdown() {
                this.dropdown.style.display = 'none';
                document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.submenu-panel').forEach(p => p.style.display = 'none');
                document.querySelectorAll('.dropdown-item.submenu').forEach(b => b.classList.remove('active'));
                this.currentMenu = null;
            }

            newDocument() {
                if (this.textarea.value && confirm('Discard current document?')) {
                    this.textarea.value = '';
                    this.history[this.activePane] = [];
                    this.redoStack[this.activePane] = [];
                    this.updateStatus();
                    this.applySyntaxHighlight();
                    this.updateLineNumbers();
                    this.minimaps[this.activePane].updateMinimap();
                }
            }

            openFile() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.txt,.md,.js,.html,.css';
                input.onchange = e => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = e => {
                        this.textarea.value = e.target.result;
                        this.history[this.activePane] = [e.target.result];
                        this.redoStack[this.activePane] = [];
                        this.updateStatus();
                        this.applySyntaxHighlight();
                        this.updateLineNumbers();
                        this.detectLanguage(file.name);
                        this.minimaps[this.activePane].updateMinimap();
                    };
                    reader.readAsText(file);
                };
                input.click();
            }

            saveFile() {
                try {
                    const blob = new Blob([this.textarea.value], { type: 'text/plain' });
                    this.downloadFile(blob, 'document.txt');
                } catch (err) {
                    console.error('Save failed:', err);
                    alert('Failed to save file');
                }
            }

            saveFileAs() {
                const name = prompt('Enter file name:', 'document.txt');
                if (name) {
                    try {
                        const blob = new Blob([this.textarea.value], { type: 'text/plain' });
                        this.downloadFile(blob, name);
                    } catch (err) {
                        console.error('Save As failed:', err);
                        alert('Failed to save file');
                    }
                }
            }

            exportMarkdown() {
                try {
                    const blob = new Blob([this.textarea.value], { type: 'text/markdown' });
                    this.downloadFile(blob, 'document.md');
                } catch (err) {
                    console.error('Export failed:', err);
                    alert('Failed to export as Markdown');
                }
            }

            downloadFile(blob, name) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = name;
                a.click();
                URL.revokeObjectURL(url);
            }

            autoSave() {
                if (this.settings.autoSave && this.textarea.value) {
                    this.statusIndicator.classList.add('active');
                    this.saveFile();
                    setTimeout(() => this.statusIndicator.classList.remove('active'), 1000);
                }
            }

            undo() {
                if (this.history[this.activePane].length > 1) {
                    this.redoStack[this.activePane].push(this.history[this.activePane].pop());
                    this.textarea.value = this.history[this.activePane][this.history[this.activePane].length - 1] || '';
                    this.updateStatus();
                    this.applySyntaxHighlight();
                    this.updateLineNumbers();
                    this.minimaps[this.activePane].updateMinimap();
                }
            }

            redo() {
                if (this.redoStack[this.activePane].length > 0) {
                    const text = this.redoStack[this.activePane].pop();
                    this.history[this.activePane].push(text);
                    this.textarea.value = text;
                    this.updateStatus();
                    this.applySyntaxHighlight();
                    this.updateLineNumbers();
                    this.minimaps[this.activePane].updateMinimap();
                }
            }

            cutText() {
                navigator.clipboard.writeText(this.textarea.value.substring(this.textarea.selectionStart, this.textarea.selectionEnd));
                this.textarea.setRangeText('');
                this.history[this.activePane].push(this.textarea.value);
                this.updateStatus();
                this.applySyntaxHighlight();
                this.updateLineNumbers();
                this.minimaps[this.activePane].updateMinimap();
            }

            copyText() {
                navigator.clipboard.writeText(this.textarea.value.substring(this.textarea.selectionStart, this.textarea.selectionEnd));
            }

            pasteText() {
                navigator.clipboard.readText().then(text => {
                    this.textarea.setRangeText(text);
                    this.history[this.activePane].push(this.textarea.value);
                    this.updateStatus();
                    this.applySyntaxHighlight();
                    this.updateLineNumbers();
                    this.minimaps[this.activePane].updateMinimap();
                });
            }

            selectAll() {
                this.textarea.select();
                this.updateStatus();
            }

            autoComplete() {
                const languageRules = {
                    javascript: ['if', 'else', 'function', 'const', 'let', 'var', 'return'],
                    python: ['def', 'if', 'else', 'elif', 'for', 'while', 'import'],
                    html: ['div', 'span', 'p', 'a', 'img'],
                    css: ['color', 'background', 'margin', 'padding'],
                    markdown: ['#', '##', '###']
                };
                const suggestions = languageRules[this.settings.languageMode] || [];
                const cursorPos = this.textarea.selectionStart;
                const textBefore = this.textarea.value.substring(0, cursorPos);
                const lastWord = textBefore.split(/\s+/).pop();
                const match = suggestions.find(s => s.startsWith(lastWord));
                if (match) {
                    this.textarea.setRangeText(match, cursorPos - lastWord.length, cursorPos);
                    this.history[this.activePane].push(this.textarea.value);
                    this.updateStatus();
                    this.applySyntaxHighlight();
                    this.updateLineNumbers();
                    this.minimaps[this.activePane].updateMinimap();
                }
            }

            toggleWordWrap() {
                this.settings.wordWrap = !this.settings.wordWrap;
                document.getElementById('word-wrap').checked = this.settings.wordWrap;
                this.applySettings();
                this.saveSettings();
                document.getElementById('wrap-status').textContent = `Wrap: ${this.settings.wordWrap ? 'On' : 'Off'}`;
            }

            toggleFullScreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }

            toggleTheme() {
                this.settings.theme = this.settings.theme === 'light' ? 'dark' : 'light';
                document.getElementById('theme').value = this.settings.theme;
                this.applySettings();
                this.saveSettings();
            }

            zoom(factor) {
                this.settings.fontSize = Math.max(8, Math.min(72, this.settings.fontSize + factor));
                document.getElementById('font-size').value = this.settings.fontSize;
                document.documentElement.style.setProperty('--font-size', `clamp(${this.settings.fontSize - 2}px, 2.5vw, ${this.settings.fontSize}px)`);
                this.applySettings();
                this.saveSettings();
            }

            toggleLineNumbers() {
                this.settings.lineNumbers = !this.settings.lineNumbers;
                document.getElementById('line-numbers').checked = this.settings.lineNumbers;
                this.applySettings();
                this.saveSettings();
            }

            toggleMinimap() {
                this.settings.minimap = !this.settings.minimap;
                document.getElementById('minimap').checked = this.settings.minimap;
                this.applySettings();
                this.saveSettings();
            }

            splitView(direction) {
                if (this.splitPanes.length >= 2) return alert('Only one split allowed');
                const newPaneId = `pane-${Date.now()}`;
                this.splitPanes.push(newPaneId);
                this.history[newPaneId] = [];
                this.redoStack[newPaneId] = [];
                this.container.className = `split-view ${direction}`;
                const newPane = document.createElement('div');
                newPane.className = 'editor-pane';
                newPane.dataset.pane = newPaneId;
                newPane.innerHTML = `
                    <div class="line-numbers-container"></div>
                    <div class="highlight-layer"></div>
                    <textarea spellcheck="false" placeholder="Start typing..."></textarea>
                    <div class="minimap-container">
                        <div class="minimap"></div>
                    </div>
                `;
                this.container.appendChild(newPane);
                const newTextarea = newPane.querySelector('textarea');
                newTextarea.value = this.textarea.value;
                this.setupPaneEvents(newPane);
                this.minimaps[newPaneId] = new Minimap(newPane);
                this.applySettings();
            }

            removeSplit() {
                if (this.splitPanes.length <= 1) return;
                const removedPane = this.splitPanes.pop();
                const paneElement = this.container.querySelector(`.editor-pane[data-pane="${removedPane}"]`);
                paneElement.remove();
                delete this.history[removedPane];
                delete this.redoStack[removedPane];
                delete this.minimaps[removedPane];
                this.container.className = 'split-view';
                this.activePane = 'main';
                const mainPane = this.container.querySelector('.editor-pane[data-pane="main"]');
                this.textarea = mainPane.querySelector('textarea');
                this.highlightLayer = mainPane.querySelector('.highlight-layer');
                this.lineNumberContainer = mainPane.querySelector('.line-numbers-container');
                this.applySettings();
            }

            showWordCount() {
                const words = this.textarea.value.trim().split(/\s+/).filter(w => w).length;
                alert(`Word Count: ${words}`);
            }

            toggleSpellCheck() {
                this.textarea.spellcheck = !this.textarea.spellcheck;
            }

            toUpperCase() {
                const start = this.textarea.selectionStart;
                const end = this.textarea.selectionEnd;
                this.textarea.setRangeText(this.textarea.value.substring(start, end).toUpperCase());
                this.history[this.activePane].push(this.textarea.value);
                this.updateStatus();
                this.minimaps[this.activePane].updateMinimap();
            }

            toLowerCase() {
                const start = this.textarea.selectionStart;
                const end = this.textarea.selectionEnd;
                this.textarea.setRangeText(this.textarea.value.substring(start, end).toLowerCase());
                this.history[this.activePane].push(this.textarea.value);
                this.updateStatus();
                this.minimaps[this.activePane].updateMinimap();
            }

            trimWhitespace() {
                this.textarea.value = this.textarea.value.trim();
                this.history[this.activePane].push(this.textarea.value);
                this.updateStatus();
                this.applySyntaxHighlight();
                this.updateLineNumbers();
                this.minimaps[this.activePane].updateMinimap();
            }

            insertDate() {
                const date = new Date().toLocaleDateString();
                this.textarea.setRangeText(date);
                this.history[this.activePane].push(this.textarea.value);
                this.updateStatus();
                this.minimaps[this.activePane].updateMinimap();
            }

            insertTime() {
                const time = new Date().toLocaleTimeString();
                this.textarea.setRangeText(time);
                this.history[this.activePane].push(this.textarea.value);
                this.updateStatus();
                this.minimaps[this.activePane].updateMinimap();
            }

            insertSpecialChar(char) {
                this.textarea.setRangeText(char);
                this.history[this.activePane].push(this.textarea.value);
                this.updateStatus();
                this.minimaps[this.activePane].updateMinimap();
            }

            showCharMap() {
                alert('Character Map: Coming soon!');
            }

            togglePanel() {
                this.panel.classList.toggle('active');
            }

            closeEditor() {
                if (confirm('Are you sure you want to close?')) {
                    window.close();
                }
            }

            resetSettings() {
                if (confirm('Reset all settings?')) {
                    this.settings = {
                        fontFamily: 'JetBrains Mono',
                        fontSize: 14,
                        theme: 'light',
                        syntaxHighlight: false,
                        autoSave: false,
                        lineNumbers: false,
                        wordWrap: false,
                        minimap: false,
                        languageMode: 'plaintext',
                        tabSize: 4,
                        textColor: '#212529',
                        bgColor: '#f8f9fa'
                    };
                    document.documentElement.style.setProperty('--font-size', 'clamp(12px, 2.5vw, 14px)');
                    this.updateSettingsUI();
                    this.applySettings();
                    localStorage.removeItem('wordnoteSettings');
                }
            }

            saveSettings() {
                localStorage.setItem('wordnoteSettings', JSON.stringify(this.settings));
            }

            loadSettings() {
                const saved = localStorage.getItem('wordnoteSettings');
                if (saved) {
                    this.settings = JSON.parse(saved);
                    document.documentElement.style.setProperty('--font-size', `clamp(${this.settings.fontSize - 2}px, 2.5vw, ${this.settings.fontSize}px)`);
                    this.updateSettingsUI();
                }
            }

            updateSettingsUI() {
                document.getElementById('font-family').value = this.settings.fontFamily;
                document.getElementById('font-size').value = this.settings.fontSize;
                document.getElementById('theme').value = this.settings.theme;
                document.getElementById('syntax-highlight').checked = this.settings.syntaxHighlight;
                document.getElementById('auto-save').checked = this.settings.autoSave;
                document.getElementById('line-numbers').checked = this.settings.lineNumbers;
                document.getElementById('word-wrap').checked = this.settings.wordWrap;
                document.getElementById('minimap').checked = this.settings.minimap;
                document.getElementById('language-mode').value = this.settings.languageMode;
                document.getElementById('tab-size').value = this.settings.tabSize;
                document.getElementById('text-color').value = this.settings.textColor;
                document.getElementById('bg-color').value = this.settings.bgColor;
            }

            handleInput() {
                this.history[this.activePane].push(this.textarea.value);
                if (this.history[this.activePane].length > 50) this.history[this.activePane].shift();
                this.redoStack[this.activePane] = [];
                this.updateStatus();
                if (this.settings.syntaxHighlight) {
                    this.applySyntaxHighlight();
                }
                this.updateLineNumbers();
                this.minimaps[this.activePane].updateMinimap();
            }

            handleKeydown(e) {
                if (e.ctrlKey) {
                    switch (e.key) {
                        case 's': e.preventDefault(); this.saveFile(); break;
                        case 'o': e.preventDefault(); this.openFile(); break;
                        case 'n': e.preventDefault(); this.newDocument(); break;
                        case 'z': e.preventDefault(); this.undo(); break;
                        case 'y': e.preventDefault(); this.redo(); break;
                        case '+': e.preventDefault(); this.zoom(2); break;
                        case '-': e.preventDefault(); this.zoom(-2); break;
                        case 'a': e.preventDefault(); this.selectAll(); break;
                        case ' ': e.preventDefault(); this.autoComplete(); break;
                    }
                } else if (e.key === 'F11') {
                    e.preventDefault();
                    this.toggleFullScreen();
                } else if (e.key === 'Tab') {
                    e.preventDefault();
                    this.textarea.setRangeText(' '.repeat(this.settings.tabSize));
                    this.history[this.activePane].push(this.textarea.value);
                    this.updateStatus();
                    this.minimaps[this.activePane].updateMinimap();
                }
            }

            updateStatus() {
                const text = this.textarea.value || '';
                const lines = text.split('\n');
                const cursorPos = this.textarea.selectionStart;
                const words = text.trim().split(/\s+/).filter(w => w).length;
                const chars = text.length;
                const sizeKB = (text.length / 1024).toFixed(2);
                let line = 1;
                let col = 1;

                for (let i = 0; i < cursorPos; i++) {
                    if (text[i] === '\n') {
                        line++;
                        col = 1;
                    } else {
                        col++;
                    }
                }

                document.getElementById('cursor-pos').textContent = `Ln ${line}, Col ${col}`;
                document.getElementById('doc-stats').textContent = `Words: ${words} | Chars: ${chars}`;
                document.getElementById('file-size').textContent = `${sizeKB} KB`;
                document.getElementById('lang-mode').textContent = this.settings.languageMode.charAt(0).toUpperCase() + this.settings.languageMode.slice(1);
                document.getElementById('wrap-status').textContent = `Wrap: ${this.settings.wordWrap ? 'On' : 'Off'}`;
            }

            applySettings() {
                const panes = this.container.querySelectorAll('.editor-pane');
                panes.forEach(pane => {
                    const textarea = pane.querySelector('textarea');
                    const highlightLayer = pane.querySelector('.highlight-layer');
                    const lineNumberContainer = pane.querySelector('.line-numbers-container');
                    const minimapContainer = pane.querySelector('.minimap-container');

                    textarea.style.fontFamily = this.settings.fontFamily;
                    textarea.style.fontSize = `${this.settings.fontSize}px`;
                    textarea.style.color = this.settings.textColor;
                    textarea.style.backgroundColor = this.settings.bgColor;
                    textarea.style.whiteSpace = this.settings.wordWrap ? 'pre-wrap' : 'pre';
                    highlightLayer.style.fontFamily = this.settings.fontFamily;
                    highlightLayer.style.fontSize = `${this.settings.fontSize}px`;
                    highlightLayer.style.color = this.settings.syntaxHighlight ? 'transparent' : this.settings.textColor;
                    highlightLayer.style.backgroundColor = 'transparent';
                    highlightLayer.style.whiteSpace = this.settings.wordWrap ? 'pre-wrap' : 'pre';
                    lineNumberContainer.style.fontFamily = this.settings.fontFamily;
                    lineNumberContainer.style.fontSize = `${this.settings.fontSize}px`;
                    lineNumberContainer.style.display = this.settings.lineNumbers && window.innerWidth > 768 ? 'block' : 'none';
                    minimapContainer.style.display = this.settings.minimap && window.innerWidth > 768 ? 'block' : 'none';
                    highlightLayer.style.left = this.settings.lineNumbers && window.innerWidth > 768 ? 'clamp(30px, 5vw, 40px)' : 'var(--screen-gap)';
                    textarea.style.marginLeft = this.settings.lineNumbers && window.innerWidth > 768 ? '0' : 'var(--screen-gap)';
                });

                this.applyTheme();
                this.updateLineNumbers();
                if (this.settings.syntaxHighlight) {
                    this.applySyntaxHighlight();
                } else {
                    this.highlightLayer.innerHTML = '';
                    this.textarea.style.color = this.settings.textColor;
                }
            }

            applyTheme() {
                const themes = {
                    light: {
                        '--light-bg': this.settings.bgColor,
                        '--dark-text': this.settings.textColor,
                        '--menu-bg': 'linear-gradient(135deg, #ffffff, #f0f0f0)',
                        '--dropdown-bg': 'white',
                        '--textarea-bg': 'white',
                        '--status-bg': 'white'
                    },
                    dark: {
                        '--light-bg': '#212529',
                        '--dark-text': '#f8f9fa',
                        '--menu-bg': 'linear-gradient(135deg, #2d2d2d, #252525)',
                        '--dropdown-bg': '#2d2d2d',
                        '--textarea-bg': '#252525',
                        '--status-bg': '#2d2d2d'
                    },
                    solarized: {
                        '--light-bg': '#fdf6e3',
                        '--dark-text': '#657b83',
                        '--menu-bg': 'linear-gradient(135deg, #fdf6e3, #eee8d5)',
                        '--dropdown-bg': '#fdf6e3',
                        '--textarea-bg': '#fdf6e3',
                        '--status-bg': '#eee8d5'
                    },
                    dracula: {
                        '--light-bg': '#282a36',
                        '--dark-text': '#f8f8f2',
                        '--menu-bg': 'linear-gradient(135deg, #282a36, #21232c)',
                        '--dropdown-bg': '#282a36',
                        '--textarea-bg': '#282a36',
                        '--status-bg': '#21232c'
                    }
                };

                Object.entries(themes[this.settings.theme] || themes.light).forEach(([key, value]) => {
                    document.documentElement.style.setProperty(key, value);
                });
            }

            applySyntaxHighlight() {
                if (!this.settings.syntaxHighlight) {
                    this.highlightLayer.innerHTML = '';
                    this.textarea.style.color = this.settings.textColor;
                    return;
                }

                const languageRules = {
                    javascript: {
                        keywords: ['function', 'const', 'let', 'var', 'if', 'else', 'return', 'for', 'while', 'class'],
                        keywordColor: '#0078d4',
                        stringColor: '#e6c07b',
                        commentColor: '#6a737d',
                        numberColor: '#d19a66'
                    },
                    python: {
                        keywords: ['def', 'class', 'if', 'else', 'elif', 'for', 'while', 'return', 'import'],
                        keywordColor: '#3572A5',
                        stringColor: '#e6db74',
                        commentColor: '#75715e',
                        numberColor: '#d19a66'
                    },
                    html: {
                        keywords: ['<!DOCTYPE', '<html', '<head', '<body', '<div', '<span'],
                        keywordColor: '#e34c26',
                        stringColor: '#032f62',
                        commentColor: '#969896',
                        numberColor: '#d19a66'
                    },
                    css: {
                        keywords: ['color', 'background', 'margin', 'padding', 'font'],
                        keywordColor: '#563d7c',
                        stringColor: '#e6c07b',
                        commentColor: '#6a737d',
                        numberColor: '#d19a66'
                    },
                    markdown: {
                        keywords: ['#', '##', '###'],
                        keywordColor: '#d73a49',
                        stringColor: '#032f62',
                        commentColor: '#6a737d',
                        numberColor: '#d19a66'
                    }
                };

                const rules = languageRules[this.settings.languageMode] || {};
                const keywords = rules.keywords || [];
                const strings = /(["'`])(?:(?=(\\?))\2.)*?\1/g;
                const comments = /(\/\/.*$|\/\*[\s\S]*?\*\/)/gm;
                const numbers = /\b\d+\b/g;

                let content = this.textarea.value
                    .replace(/&/g, '&')
                    .replace(/</g, '<')
                    .replace(/>/g, '>');

                content = content
                    .replace(comments, match => `<span style="color: ${rules.commentColor || '#6a737d'}">${match}</span>`)
                    .replace(strings, match => `<span style="color: ${rules.stringColor || '#e6c07b'}">${match}</span>`)
                    .replace(numbers, match => `<span style="color: ${rules.numberColor || '#d19a66'}">${match}</span>`)
                    .replace(new RegExp(`\\b(${keywords.join('|')})\\b`, 'g'), 
                        match => `<span style="color: ${rules.keywordColor || '#0078d4'}">${match}</span>`);

                this.highlightLayer.innerHTML = content;
                this.textarea.style.color = 'transparent';
                this.textarea.style.caretColor = this.settings.textColor;
            }

            detectLanguage(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const extMap = {
                    'js': 'javascript',
                    'py': 'python',
                    'html': 'html',
                    'css': 'css',
                    'md': 'markdown',
                    'txt': 'plaintext'
                };
                this.settings.languageMode = extMap[ext] || 'plaintext';
                document.getElementById('language-mode').value = this.settings.languageMode;
                this.applySettings();
                this.saveSettings();
            }

            updateLineNumbers() {
                const lines = this.textarea.value.split('\n');
                this.lineNumberContainer.innerHTML = Array.from(
                    { length: lines.length },
                    (_, i) => `<div style="line-height: ${this.settings.fontSize * 1.5}px">${i + 1}</div>`
                ).join('');
            }

            syncLineNumbersScroll() {
                this.lineNumberContainer.scrollTop = this.textarea.scrollTop;
                this.highlightLayer.scrollTop = this.textarea.scrollTop;
            }
        }

        const editor = new WordnotePro();
        document.body.addEventListener('click', e => {
            if (!e.target.closest('.menu-btn') && !e.target.closest('.dropdown') && !e.target.closest('#settings-panel')) {
                editor.hideDropdown();
            }
        });
    </script>
</body>
</html>