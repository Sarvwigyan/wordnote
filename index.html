<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wordnote Pro Enhanced</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #0078d4;
            --secondary-color: #e0e0e0;
            --shadow: 0 0.25rem 0.9375rem rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --border-radius: 0.5rem;
            --font-size: clamp(12px, 2.5vw, 14px);
            --screen-gap: clamp(5px, 2vw, 10px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-color, #f5f6f5);
            color: var(--text-color, #333);
            height: 100vh;
            transition: var(--transition);
            font-size: var(--font-size);
            overflow: hidden;
        }

        #container {
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            position: relative;
            width: 100%;
        }

        #menu-bar {
            background: var(--menu-bg, linear-gradient(135deg, #ffffff, #f0f0f0));
            padding: clamp(0.3rem, 1vw, 0.5rem) clamp(0.5rem, 2vw, 1rem);
            display: flex;
            flex-wrap: wrap;
            gap: clamp(0.3rem, 1vw, 0.5rem);
            border-bottom: 2px solid var(--border-color, #ddd);
            box-shadow: var(--shadow);
            z-index: 1000;
            position: sticky;
            top: 0;
        }

        .menu-btn {
            padding: clamp(0.4rem, 1.5vw, 0.6rem) clamp(0.8rem, 2.5vw, 1.2rem);
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: var(--border-radius);
            font-weight: 500;
            transition: var(--transition);
            color: var(--menu-text, #333);
            position: relative;
            overflow: hidden;
            font-size: clamp(12px, 2vw, 14px);
        }

        .menu-btn:hover::after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

        .menu-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--primary-color);
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.3s ease-out;
        }

        .menu-btn:hover, .menu-btn:focus {
            background: var(--hover-bg, rgba(0,120,212,0.1));
            outline: none;
        }

        .menu-btn.active {
            background: var(--active-bg, rgba(0,120,212,0.2));
        }

        .dropdown {
            position: fixed;
            background: var(--dropdown-bg, white);
            border: 1px solid var(--border-color, #ddd);
            border-radius: var(--border-radius);
            min-width: clamp(4rem, 20vw, 5rem);
            max-width: clamp(10rem, 40vw, 15rem);
            box-shadow: var(--shadow);
            animation: slideIn 0.2s ease-out;
            z-index: 2000;
            max-height: calc(100vh - var(--screen-gap) * 2);
            overflow-y: auto;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dropdown-item {
            padding: clamp(0.5rem, 1.5vw, 0.7rem) clamp(0.8rem, 2vw, 1rem);
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            width: 100%;
            transition: var(--transition);
            color: var(--dropdown-text, #333);
            font-size: clamp(11px, 2vw, 0.95rem);
        }

        .dropdown-item:hover,
        .dropdown-item:focus {
            background: var(--hover-bg, #f0f0f0);
            color: var(--primary-color);
            outline: none;
        }

        .dropdown-item.submenu::after {
            content: '▼';
            float: right;
            font-size: clamp(0.6rem, 1.5vw, 0.8rem);
            transition: transform 0.2s ease;
        }

        .dropdown-item.submenu.active::after {
            transform: rotate(180deg);
        }

        .submenu-panel {
            position: fixed;
            background: var(--dropdown-bg, white);
            border: 1px solid var(--border-color, #ddd);
            border-radius: var(--border-radius);
            min-width: clamp(100px, 25vw, 150px);
            box-shadow: var(--shadow);
            animation: slideIn 0.2s ease-out;
            z-index: 2001;
            display: none;
            max-height: calc(100vh - var(--screen-gap) * 2);
            overflow-y: auto;
        }

        #editor-container {
            position: relative;
            display: flex;
            overflow: hidden;
            flex: 1;
            width: 100%;
        }

        #line-numbers-container {
            width: clamp(30px, 5vw, 40px);
            background: var(--textarea-bg, white);
            color: var(--status-color, #666);
            font-family: var(--font-family, 'JetBrains Mono'), monospace;
            font-size: var(--font-size);
            text-align: right;
            padding: clamp(1rem, 2vw, 1.5rem) clamp(0.3rem, 1vw, 0.5rem) clamp(1rem, 2vw, 1.5rem) 0;
            margin: var(--screen-gap) 0 var(--screen-gap) var(--screen-gap);
            overflow-y: auto;
            user-select: none;
            z-index: 2;
            display: none;
            border-right: 1px solid var(--border-color, #ddd);
        }

        #textarea {
            flex: 1;
            padding: clamp(1rem, 2vw, 1.5rem);
            border: none;
            resize: none;
            font-family: var(--font-family, 'JetBrains Mono'), monospace;
            font-size: var(--font-size);
            background: var(--textarea-bg, white);
            color: var(--text-color, #333);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            outline: none;
            transition: var(--transition);
            border-radius: var(--border-radius);
            margin: var(--screen-gap);
            line-height: 1.5;
            width: 100%;
        }

        #highlight-layer {
            position: absolute;
            top: var(--screen-gap);
            left: clamp(30px, 5vw, 40px);
            right: var(--screen-gap);
            bottom: var(--screen-gap);
            padding: clamp(1rem, 2vw, 1.5rem);
            pointer-events: none;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            font-family: var(--font-family, 'JetBrains Mono'), monospace;
            font-size: var(--font-size);
            line-height: 1.5;
            color: var(--text-color, #333);
            z-index: 1;
        }

        #status-bar {
            padding: clamp(0.4rem, 1.5vw, 0.7rem) clamp(1rem, 2vw, 1.5rem);
            background: var(--status-bg, #fafafa);
            border-top: 1px solid var(--border-color, #ddd);
            font-size: clamp(10px, 2vw, 0.9rem);
            color: var(--status-color, #666);
            display: flex;
            justify-content: space-between;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.03);
            flex-wrap: wrap;
            align-items: center;
        }

        #customization-panel {
            position: fixed;
            right: -100%;
            top: 0;
            width: clamp(300px, 50%, 450px);
            height: 100%;
            background: var(--panel-bg, white);
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            transition: var(--transition);
            z-index: 1500;
            overflow-y: auto;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            padding: clamp(0.5rem, 2vw, 1rem);
        }

        #customization-panel.active {
            right: 0;
        }

        .panel-header {
            padding: clamp(0.5rem, 2vw, 1rem);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--panel-bg);
            z-index: 1;
        }

        .panel-header h2 {
            font-size: clamp(1rem, 3vw, 1.4rem);
            color: var(--text-color);
        }

        #close-panel-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: clamp(0.3rem, 1vw, 0.5rem);
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        #close-panel-btn svg {
            width: clamp(16px, 3vw, 20px);
            height: clamp(16px, 3vw, 20px);
            fill: var(--text-color);
        }

        #close-panel-btn:hover svg {
            fill: var(--primary-color);
            transform: scale(1.1);
        }

        #close-panel-btn:hover {
            transform: none;
        }

        .panel-section {
            margin: clamp(1rem, 2vw, 1.5rem) 0;
            padding: clamp(1rem, 2vw, 1.5rem);
            background: rgba(0,0,0,0.02);
            border-radius: var(--border-radius);
        }

        .panel-section h3 {
            margin-bottom: clamp(0.5rem, 1.5vw, 1rem);
            color: var(--text-color);
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
            font-weight: 600;
        }

        .setting-group {
            margin-bottom: clamp(1rem, 2vw, 1.5rem);
        }

        .setting-group label {
            display: block;
            margin-bottom: clamp(0.3rem, 1vw, 0.5rem);
            color: var(--text-color);
            font-size: clamp(11px, 2vw, 0.95rem);
        }

        select, 
        input[type="number"],
        input[type="checkbox"],
        input[type="color"] {
            width: 100%;
            padding: clamp(0.5rem, 1.5vw, 0.8rem);
            margin: clamp(0.2rem, 0.5vw, 0.3rem) 0;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: clamp(11px, 2vw, 0.95rem);
            transition: var(--transition);
            background: var(--input-bg);
            color: var(--text-color);
        }

        #theme, #font-family {
            max-height: clamp(150px, 40vh, 200px);
            overflow-y: auto;
        }

        input[type="checkbox"] {
            width: auto;
            margin-right: clamp(0.3rem, 1vw, 0.5rem);
        }

        select:hover,
        input[type="number"]:hover,
        input[type="checkbox"]:hover + span,
        input[type="color"]:hover {
            border-color: var(--primary-color);
        }

        select:focus,
        input[type="number"]:focus,
        input[type="color"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(0,120,212,0.3);
        }

        .button-group {
            display: flex;
            gap: clamp(0.5rem, 1.5vw, 1rem);
            margin-top: clamp(0.5rem, 2vw, 1rem);
            flex-wrap: wrap;
        }

        button:not(.menu-btn) {
            padding: clamp(0.5rem, 1.5vw, 0.8rem) clamp(1rem, 2vw, 1.5rem);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            flex: 1;
            min-width: 0;
            font-size: clamp(11px, 2vw, 0.95rem);
        }

        .primary-btn {
            background: var(--primary-color);
            color: white;
        }

        .primary-btn:hover {
            background: #005fa3;
        }

        .secondary-btn {
            background: var(--border-color);
            color: var(--text-color);
        }

        .secondary-btn:hover {
            background: #c0c0c0;
        }

        .color-picker {
            height: 2rem;
            padding: 0.2rem;
        }

        #search-replace-panel {
            position: fixed;
            top: 25%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--panel-bg);
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 2000;
            display: none;
            width: clamp(200px, 50vw, 400px);
        }

        #search-replace-panel input {
            margin: 0.5rem 0;
            width: 100%;
        }

        @media (max-width: 768px) {
            #menu-bar {
                justify-content: center;
            }

            .menu-btn {
                flex: 1;
                min-width: 0;
            }

            #customization-panel {
                width: 80%;
            }

            #line-numbers-container {
                display: none !important;
            }

            #highlight-layer {
                left: var(--screen-gap);
            }

            #textarea {
                margin-left: var(--screen-gap);
            }
        }

        @media (max-width: 480px) {
            #customization-panel {
                width: 100%;
                border-radius: 0;
            }

            .panel-header h2 {
                font-size: clamp(0.9rem, 4vw, 1.2rem);
            }

            .button-group {
                flex-direction: column;
            }

            #status-bar {
                flex-direction: column;
                text-align: center;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="menu-bar">
            <button class="menu-btn" id="file-btn" aria-label="File menu">File</button>
            <button class="menu-btn" id="edit-btn" aria-label="Edit menu">Edit</button>
            <button class="menu-btn" id="format-btn" aria-label="Format menu">Format</button>
            <button class="menu-btn" id="view-btn" aria-label="View menu">View</button>
            <button class="menu-btn" id="tools-btn" aria-label="Tools menu">Tools</button>
            <button class="menu-btn" id="insert-btn" aria-label="Insert menu">Insert</button>
            <button class="menu-btn" id="help-btn" aria-label="Help menu">Help</button>
            <div id="dropdown" class="dropdown" style="display: none;"></div>
        </div>
        <div id="editor-container">
            <div id="line-numbers-container"></div>
            <div id="highlight-layer"></div>
            <textarea id="textarea" spellcheck="false" aria-label="Text editor"></textarea>
        </div>
        <div id="status-bar">
            <span id="cursor-pos">Ln 1, Col 1</span>
            <span id="doc-stats">Words: 0 | Chars: 0</span>
            <span id="lang-mode">Plain Text</span>
        </div>
        <div id="customization-panel">
            <div class="panel-header">
                <h2>Settings</h2>
                <button id="close-panel-btn" aria-label="Close settings">
                    <svg viewBox="0 0 24 24">
                        <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="panel-section">
                <h3>Appearance</h3>
                <div class="setting-group">
                    <label for="font-family">Font Family</label>
                    <select id="font-family">
                        <option value="JetBrains Mono">JetBrains Mono</option>
                        <option value="Fira Code">Fira Code</option>
                        <option value="Roboto Mono">Roboto Mono</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Source Code Pro">Source Code Pro</option>
                        <option value="Inconsolata">Inconsolata</option>
                        <option value="IBM Plex Mono">IBM Plex Mono</option>
                        <option value="Space Mono">Space Mono</option>
                        <option value="Ubuntu Mono">Ubuntu Mono</option>
                        <option value="Cascadia Code">Cascadia Code</option>
                        <option value="Consolas">Consolas</option>
                        <option value="Monaco">Monaco</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="font-size">Font Size</label>
                    <input type="number" id="font-size" min="8" max="72" value="14">
                </div>
                <div class="setting-group">
                    <label for="theme">Theme</label>
                    <select id="theme">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="solarized">Solarized</option>
                        <option value="dracula">Dracula</option>
                        <option value="nord">Nord</option>
                        <option value="monokai">Monokai</option>
                        <option value="github">GitHub</option>
                        <option value="github-dark">GitHub Dark</option>
                        <option value="material">Material</option>
                        <option value="vscode">VS Code</option>
                        <option value="atom">Atom One Dark</option>
                        <option value="sublime">Sublime</option>
                        <option value="oceanic">Oceanic Next</option>
                        <option value="gruvbox">Gruvbox</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="text-color">Text Color</label>
                    <input type="color" id="text-color" value="#333333">
                </div>
                <div class="setting-group">
                    <label for="bg-color">Background Color</label>
                    <input type="color" id="bg-color" value="#f5f6f5">
                </div>
            </div>
            <div class="panel-section">
                <h3>Editor Features</h3>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="syntax-highlight">
                        <span>Syntax Highlighting</span>
                    </label>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="auto-save">
                        <span>Auto Save</span>
                    </label>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="line-numbers">
                        <span>Line Numbers</span>
                    </label>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="word-wrap">
                        <span>Word Wrap</span>
                    </label>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="minimap">
                        <span>Minimap</span>
                    </label>
                </div>
                <div class="setting-group">
                    <label for="language-mode">Language Mode</label>
                    <select id="language-mode">
                        <option value="plaintext">Plain Text</option>
                        <option value="javascript">JavaScript</option>
                        <option value="python">Python</option>
                        <option value="html">HTML</option>
                        <option value="css">CSS</option>
                        <option value="markdown">Markdown</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="tab-size">Tab Size</label>
                    <input type="number" id="tab-size" min="2" max="8" value="4">
                </div>
            </div>
            <div class="panel-section">
                <h3>Export Options</h3>
                <div class="button-group">
                    <button class="primary-btn" id="export-md">Export as Markdown</button>
                    <button class="primary-btn" id="export-pdf">Export as PDF</button>
                </div>
                <div class="button-group">
                    <button class="secondary-btn" id="reset-settings">Reset Settings</button>
                    <button class="secondary-btn" id="save-settings">Save Settings</button>
                </div>
            </div>
        </div>
        <div id="search-replace-panel">
            <div class="setting-group">
                <label for="search-input">Find:</label>
                <input type="text" id="search-input">
            </div>
            <div class="setting-group">
                <label for="replace-input">Replace:</label>
                <input type="text" id="replace-input">
            </div>
            <div class="button-group">
                <button class="primary-btn" id="find-next">Find Next</button>
                <button class="primary-btn" id="replace">Replace</button>
                <button class="secondary-btn" id="replace-all">Replace All</button>
                <button class="secondary-btn" id="close-search">Close</button>
            </div>
        </div>
    </div>

    <script>
        class WordnotePro {
            constructor() {
                this.textarea = document.getElementById('textarea');
                this.dropdown = document.getElementById('dropdown');
                this.panel = document.getElementById('customization-panel');
                this.searchPanel = document.getElementById('search-replace-panel');
                this.highlightLayer = document.getElementById('highlight-layer');
                this.lineNumberContainer = document.getElementById('line-numbers-container');
                this.history = [];
                this.redoStack = [];
                this.currentMenu = null;
                this.searchIndex = -1;
                this.settings = {
                    fontFamily: 'JetBrains Mono',
                    fontSize: 14,
                    theme: 'light',
                    syntaxHighlight: false,
                    autoSave: false,
                    lineNumbers: false,
                    wordWrap: false,
                    minimap: false,
                    languageMode: 'plaintext',
                    tabSize: 4,
                    textColor: '#333333',
                    bgColor: '#f5f6f5'
                };

                this.menus = {
                    file: [
                        { text: 'New', action: () => this.newDocument(), shortcut: 'Ctrl+N' },
                        { text: 'Open', action: () => this.openFile(), shortcut: 'Ctrl+O' },
                        { text: 'Save', action: () => this.saveFile(), shortcut: 'Ctrl+S' },
                        { text: 'Save As', action: () => this.saveFileAs() },
                        { text: 'Export', submenu: [
                            { text: 'PDF', action: () => this.exportPDF() },
                            { text: 'Markdown', action: () => this.exportMarkdown() },
                            { text: 'HTML', action: () => this.exportHTML() },
                            { text: 'Text', action: () => this.saveFile() },
                            { text: 'JSON', action: () => this.exportJSON() }
                        ]},
                        { text: 'Print Text', action: () => this.printText(), shortcut: 'Ctrl+P' },
                        { text: 'Recent Files', submenu: [
                            { text: 'No recent files', action: () => {} }
                        ]},
                        { text: 'Close', action: () => this.closeEditor() }
                    ],
                    edit: [
                        { text: 'Undo', action: () => this.undo(), shortcut: 'Ctrl+Z' },
                        { text: 'Redo', action: () => this.redo(), shortcut: 'Ctrl+Y' },
                        { text: 'Cut', action: () => this.cutText(), shortcut: 'Ctrl+X' },
                        { text: 'Copy', action: () => this.copyText(), shortcut: 'Ctrl+C' },
                        { text: 'Paste', action: () => this.pasteText(), shortcut: 'Ctrl+V' },
                        { text: 'Select All', action: () => this.selectAll(), shortcut: 'Ctrl+A' },
                        { text: 'Find/Replace', action: () => this.showSearchReplace(), shortcut: 'Ctrl+F' },
                        { text: 'Go to Line', action: () => this.goToLine(), shortcut: 'Ctrl+G' },
                        { text: 'Duplicate Line', action: () => this.duplicateLine(), shortcut: 'Ctrl+D' },
                        { text: 'Delete Line', action: () => this.deleteLine(), shortcut: 'Ctrl+Shift+D' }
                    ],
                    format: [
                        { text: 'Word Wrap', action: () => this.toggleWordWrap() },
                        { text: 'Format Code', action: () => this.formatCode() },
                        { text: 'To Uppercase', action: () => this.toUpperCase() },
                        { text: 'To Lowercase', action: () => this.toLowerCase() },
                        { text: 'Trim Whitespace', action: () => this.trimWhitespace() },
                        { text: 'Convert Tabs to Spaces', action: () => this.tabsToSpaces() },
                        { text: 'Settings', action: () => this.togglePanel() }
                    ],
                    view: [
                        { text: 'Full Screen', action: () => this.toggleFullScreen(), shortcut: 'F11' },
                        { text: 'Zoom In', action: () => this.zoom(2), shortcut: 'Ctrl+Plus' },
                        { text: 'Zoom Out', action: () => this.zoom(-2), shortcut: 'Ctrl+Minus' },
                        { text: 'Reset Zoom', action: () => this.resetZoom(), shortcut: 'Ctrl+0' },
                        { text: 'Toggle Line Numbers', action: () => this.toggleLineNumbers() },
                        { text: 'Toggle Minimap', action: () => this.toggleMinimap() },
                        { text: 'Toggle Status Bar', action: () => this.toggleStatusBar() },
                        { text: 'Split View', submenu: [
                            { text: 'Horizontal Split', action: () => this.splitView('horizontal') },
                            { text: 'Vertical Split', action: () => this.splitView('vertical') },
                            { text: 'Remove Split', action: () => this.removeSplit() }
                        ]}
                    ],
                    tools: [
                        { text: 'Statistics', action: () => this.showStats() },
                        { text: 'Spell Check', action: () => this.toggleSpellCheck() },
                        { text: 'Code Runner', action: () => this.runCode() },
                        { text: 'Word Count', action: () => this.showWordCount() },
                        { text: 'Character Map', action: () => this.showCharMap() },
                        { text: 'Calculator', action: () => this.showCalculator() },
                        { text: 'Markdown Preview', action: () => this.previewMarkdown() }
                    ],
                    insert: [
                        { text: 'Current Date', action: () => this.insertDate() },
                        { text: 'Current Time', action: () => this.insertTime() },
                        { text: 'Date & Time', action: () => this.insertDateTime() },
                        { text: 'Lorem Ipsum', action: () => this.insertLoremIpsum() },
                        { text: 'Horizontal Line', action: () => this.insertHorizontalLine() },
                        { text: 'Special Characters', submenu: [
                            { text: 'Copyright ©', action: () => this.insertSpecialChar('©') },
                            { text: 'Registered ®', action: () => this.insertSpecialChar('®') },
                            { text: 'Trademark ™', action: () => this.insertSpecialChar('™') },
                            { text: 'Bullet •', action: () => this.insertSpecialChar('•') }
                        ]}
                    ],
                    help: [
                        { text: 'Documentation', action: () => window.open('https://example.com') },
                        { text: 'Keyboard Shortcuts', action: () => this.showShortcuts() },
                        { text: 'Check for Updates', action: () => this.checkUpdates() },
                        { text: 'Report Bug', action: () => this.reportBug() },
                        { text: 'About', action: () => this.showAbout() }
                    ]
                };

                this.init();
            }

            init() {
                this.loadSettings();
                this.setupEventListeners();
                this.applySettings();
                this.updateStatus();
                this.dropdown.style.display = 'none';
                window.addEventListener('resize', () => {
                    this.adjustDropdownPosition();
                    this.updateLineNumbers();
                });
            }

            setupEventListeners() {
                document.querySelectorAll('.menu-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.toggleMenu(btn);
                    });
                    btn.addEventListener('keydown', e => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            this.toggleMenu(btn);
                        }
                    });
                });

                this.textarea.addEventListener('input', () => this.handleInput());
                this.textarea.addEventListener('keydown', e => this.handleKeydown(e));
                this.textarea.addEventListener('click', () => this.updateStatus());
                this.textarea.addEventListener('scroll', () => this.syncLineNumbersScroll());

                ['font-family', 'font-size', 'theme', 'language-mode', 'tab-size'].forEach(id => {
                    document.getElementById(id).addEventListener('change', e => {
                        this.settings[id.replace('-', '')] = e.target.value;
                        this.applySettings();
                        this.saveSettings();
                    });
                });

                ['syntax-highlight', 'auto-save', 'line-numbers', 'word-wrap', 'minimap'].forEach(id => {
                    document.getElementById(id).addEventListener('change', e => {
                        this.settings[id.replace('-', '')] = e.target.checked;
                        this.applySettings();
                        this.saveSettings();
                    });
                });

                ['text-color', 'bg-color'].forEach(id => {
                    document.getElementById(id).addEventListener('change', e => {
                        this.settings[id.replace('-', '')] = e.target.value;
                        this.applySettings();
                        this.saveSettings();
                    });
                });

                document.getElementById('export-md').addEventListener('click', () => this.exportMarkdown());
                document.getElementById('export-pdf').addEventListener('click', () => this.exportPDF());
                document.getElementById('reset-settings').addEventListener('click', () => this.resetSettings());
                document.getElementById('save-settings').addEventListener('click', () => this.saveSettings());
                document.getElementById('close-panel-btn').addEventListener('click', () => this.togglePanel());

                document.getElementById('find-next').addEventListener('click', () => this.findNext());
                document.getElementById('replace').addEventListener('click', () => this.replace());
                document.getElementById('replace-all').addEventListener('click', () => this.replaceAll());
                document.getElementById('close-search').addEventListener('click', () => this.hideSearchReplace());

                setInterval(() => {
                    if (this.settings.autoSave && this.textarea.value) {
                        this.saveFile();
                    }
                }, 30000);

                document.body.addEventListener('click', e => {
                    if (!e.target.closest('.menu-btn') && !e.target.closest('.dropdown') && 
                        !e.target.closest('#customization-panel') && !e.target.closest('#search-replace-panel')) {
                        this.hideDropdown();
                        this.hideSearchReplace();
                    }
                });
            }

            toggleMenu(button) {
                if (this.currentMenu === button.id) {
                    this.hideDropdown();
                } else {
                    this.showDropdown(button.id.replace('-btn', ''), button);
                    this.currentMenu = button.id;
                    this.textarea.focus();
                }
            }

            adjustDropdownPosition(dropdown = this.dropdown, button) {
                if (!button) return;
                const rect = button.getBoundingClientRect();
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                const dropdownWidth = dropdown.offsetWidth || dropdown.scrollWidth;
                const dropdownHeight = dropdown.offsetHeight || dropdown.scrollHeight;
                const screenGap = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--screen-gap'));

                let left = rect.left;
                let top = rect.bottom;

                if (left + dropdownWidth > screenWidth - screenGap) {
                    left = Math.max(screenGap, screenWidth - dropdownWidth - screenGap);
                }
                if (left < screenGap) {
                    left = screenGap;
                }

                if (top + dropdownHeight > screenHeight - screenGap) {
                    top = rect.top - dropdownHeight;
                    if (top < screenGap) {
                        top = screenHeight - dropdownHeight - screenGap;
                        if (top < rect.bottom) {
                            top = screenGap;
                            dropdown.style.maxHeight = `${screenHeight - screenGap * 2}px`;
                        }
                    }
                }

                dropdown.style.left = `${left}px`;
                dropdown.style.top = `${top}px`;

                dropdown.querySelectorAll('.submenu-panel').forEach(submenu => {
                    const parentItem = submenu.parentElement;
                    const parentRect = parentItem.getBoundingClientRect();
                    const submenuWidth = submenu.offsetWidth || submenu.scrollWidth;
                    const submenuHeight = submenu.offsetHeight || submenu.scrollHeight;

                    let submenuLeft = parentRect.right + 5;
                    let submenuTop = parentRect.top;

                    if (submenuLeft + submenuWidth > screenWidth - screenGap) {
                        submenuLeft = parentRect.left - submenuWidth - 5;
                    }
                    if (submenuLeft < screenGap) {
                        submenuLeft = screenGap;
                    }

                    if (submenuTop + submenuHeight > screenHeight - screenGap) {
                        submenuTop = screenHeight - submenuHeight - screenGap;
                        if (submenuTop < screenGap) {
                            submenuTop = screenGap;
                            submenu.style.maxHeight = `${screenHeight - screenGap * 2}px`;
                        }
                    }

                    submenu.style.left = `${submenuLeft}px`;
                    submenu.style.top = `${submenuTop}px`;
                });
            }

            showDropdown(menu, button) {
                this.hideDropdown();
                this.dropdown.style.display = 'block';
                button.classList.add('active');
                this.dropdown.innerHTML = '';

                this.menus[menu].forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'dropdown-item';
                    btn.setAttribute('role', 'menuitem');
                    btn.innerHTML = item.shortcut 
                        ? `${item.text} <span style="float: right; opacity: 0.7">${item.shortcut}</span>`
                        : item.text;

                    if (item.submenu) {
                        btn.classList.add('submenu');
                        const submenuPanel = document.createElement('div');
                        submenuPanel.className = 'submenu-panel';

                        item.submenu.forEach(subItem => {
                            const subBtn = document.createElement('button');
                            subBtn.className = 'dropdown-item';
                            subBtn.textContent = subItem.text;
                            subBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                subItem.action();
                                this.hideDropdown();
                                this.textarea.focus();
                            });
                            submenuPanel.appendChild(subBtn);
                        });

                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const isOpen = submenuPanel.style.display === 'block';
                            document.querySelectorAll('.submenu-panel').forEach(panel => panel.style.display = 'none');
                            document.querySelectorAll('.dropdown-item.submenu').forEach(b => b.classList.remove('active'));
                            if (!isOpen) {
                                submenuPanel.style.display = 'block';
                                btn.classList.add('active');
                                this.adjustDropdownPosition(this.dropdown, button);
                            }
                        });

                        btn.appendChild(submenuPanel);
                    } else {
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            item.action();
                            this.hideDropdown();
                            this.textarea.focus();
                        });
                    }
                    this.dropdown.appendChild(btn);
                });

                this.adjustDropdownPosition(this.dropdown, button);
            }

            hideDropdown() {
                this.dropdown.style.display = 'none';
                document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.submenu-panel').forEach(panel => panel.style.display = 'none');
                document.querySelectorAll('.dropdown-item.submenu').forEach(btn => btn.classList.remove('active'));
                this.currentMenu = null;
            }

            newDocument() {
                if (this.textarea.value && confirm('Discard current document?')) {
                    this.textarea.value = '';
                    this.history = [];
                    this.redoStack = [];
                    this.updateStatus();
                    this.applySyntaxHighlight();
                    this.updateLineNumbers();
                }
            }

            saveFile() {
                const blob = new Blob([this.textarea.value], { type: 'text/plain' });
                this.downloadFile(blob, 'document.txt');
            }

            saveFileAs() {
                const name = prompt('Enter file name:', 'document.txt');
                if (name) {
                    const blob = new Blob([this.textarea.value], { type: 'text/plain' });
                    this.downloadFile(blob, name);
                }
            }

            openFile() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.txt,.md,.js,.html,.json';
                input.onchange = e => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = e => {
                        this.textarea.value = e.target.result;
                        this.history.push(this.textarea.value);
                        this.redoStack = [];
                        this.updateStatus();
                        this.applySyntaxHighlight();
                        this.updateLineNumbers();
                        this.detectLanguage(file.name);
                        this.addToRecentFiles(file.name);
                    };
                    reader.readAsText(file);
                };
                input.click();
            }

            exportPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFont(this.settings.fontFamily);
                doc.setFontSize(this.settings.fontSize);
                doc.setTextColor(this.hexToRgb(this.settings.textColor));
                const splitText = doc.splitTextToSize(this.textarea.value, 180);
                doc.text(splitText, 15, 15);
                doc.save('document.pdf');
            }

            exportMarkdown() {
                const blob = new Blob([this.textarea.value], { type: 'text/markdown' });
                this.downloadFile(blob, 'document.md');
            }

            exportHTML() {
                const html = `<!DOCTYPE html><html><head><style>body {font-family: ${this.settings.fontFamily}; font-size: ${this.settings.fontSize}px; color: ${this.settings.textColor}; background: ${this.settings.bgColor};}</style></head><body><pre>${this.textarea.value}</pre></body></html>`;
                const blob = new Blob([html], { type: 'text/html' });
                this.downloadFile(blob, 'document.html');
            }

            exportJSON() {
                const json = JSON.stringify({ content: this.textarea.value, settings: this.settings });
                const blob = new Blob([json], { type: 'application/json' });
                this.downloadFile(blob, 'document.json');
            }

            printText() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFont(this.settings.fontFamily);
                doc.setFontSize(this.settings.fontSize);
                doc.setTextColor(this.hexToRgb(this.settings.textColor));
                const splitText = doc.splitTextToSize(this.textarea.value, 180);
                doc.text(splitText, 15, 15);
                const pdfBlob = doc.output('blob');
                const url = URL.createObjectURL(pdfBlob);
                const printWindow = window.open(url);
                printWindow.print();
                URL.revokeObjectURL(url);
            }

            downloadFile(blob, name) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = name;
                a.click();
                URL.revokeObjectURL(url);
            }

            undo() {
                if (this.history.length > 1) {
                    this.redoStack.push(this.history.pop());
                    this.textarea.value = this.history[this.history.length - 1] || '';
                    this.updateStatus();
                    this.applySyntaxHighlight();
                    this.updateLineNumbers();
                }
            }

            redo() {
                if (this.redoStack.length > 0) {
                    const text = this.redoStack.pop();
                    this.history.push(text);
                    this.textarea.value = text;
                    this.updateStatus();
                    this.applySyntaxHighlight();
                    this.updateLineNumbers();
                }
            }

            async cutText() {
                try {
                    const selectedText = this.textarea.value.substring(this.textarea.selectionStart, this.textarea.selectionEnd);
                    if (navigator.clipboard) {
                        await navigator.clipboard.writeText(selectedText);
                        this.textarea.setRangeText('');
                        this.history.push(this.textarea.value);
                        this.updateStatus();
                        this.applySyntaxHighlight();
                        this.updateLineNumbers();
                    } else if (document.execCommand('cut')) {
                        this.history.push(this.textarea.value);
                        this.updateStatus();
                        this.applySyntaxHighlight();
                        this.updateLineNumbers();
                    }
                } catch (err) {
                    console.error('Cut failed:', err);
                }
            }

            async copyText() {
                try {
                    const selectedText = this.textarea.value.substring(this.textarea.selectionStart, this.textarea.selectionEnd);
                    if (navigator.clipboard) {
                        await navigator.clipboard.writeText(selectedText);
                    } else {
                        document.execCommand('copy');
                    }
                } catch (err) {
                    console.error('Copy failed:', err);
                }
            }

            async pasteText() {
                try {
                    if (navigator.clipboard) {
                        const text = await navigator.clipboard.readText();
                        this.textarea.setRangeText(text);
                        this.history.push(this.textarea.value);
                        this.updateStatus();
                        this.applySyntaxHighlight();
                        this.updateLineNumbers();
                    } else if (document.execCommand('paste')) {
                        this.history.push(this.textarea.value);
                        this.updateStatus();
                        this.applySyntaxHighlight();
                        this.updateLineNumbers();
                    }
                } catch (err) {
                    console.error('Paste failed:', err);
                }
            }

            selectAll() {
                this.textarea.select();
                this.updateStatus();
            }

            showSearchReplace() {
                this.searchPanel.style.display = 'block';
                document.getElementById('search-input').focus();
            }

            hideSearchReplace() {
                this.searchPanel.style.display = 'none';
                this.searchIndex = -1;
            }

            findNext() {
                const term = document.getElementById('search-input').value;
                if (!term) return;
                const text = this.textarea.value;
                this.searchIndex = text.indexOf(term, this.searchIndex + 1);
                if (this.searchIndex === -1) {
                    this.searchIndex = text.indexOf(term, 0);
                }
                if (this.searchIndex >= 0) {
                    this.textarea.setSelectionRange(this.searchIndex, this.searchIndex + term.length);
                    this.textarea.focus();
                } else {
                    alert('Term not found');
                }
            }

            replace() {
                const term = document.getElementById('search-input').value;
                const replaceWith = document.getElementById('replace-input').value;
                if (!term) return;
                const start = this.textarea.selectionStart;
                const end = this.textarea.selectionEnd;
                if (this.textarea.value.substring(start, end) === term) {
                    this.textarea.setRangeText(replaceWith);
                    this.history.push(this.textarea.value);
                    this.updateStatus();
                    this.applySyntaxHighlight();
                    this.updateLineNumbers();
                }
                this.findNext();
            }

            replaceAll() {
                const term = document.getElementById('search-input').value;
                const replaceWith = document.getElementById('replace-input').value;
                if (!term) return;
                this.textarea.value = this.textarea.value.split(term).join(replaceWith);
                this.history.push(this.textarea.value);
                this.updateStatus();
                this.applySyntaxHighlight();
                this.updateLineNumbers();
            }

            goToLine() {
                const line = parseInt(prompt('Enter line number:'));
                if (isNaN(line) || line < 1) return;
                const lines = this.textarea.value.split('\n');
                if (line > lines.length) return;
                const pos = lines.slice(0, line - 1).join('\n').length + (line > 1 ? 1 : 0);
                this.textarea.setSelectionRange(pos, pos);
                this.textarea.focus();
            }

            duplicateLine() {
                const start = this.textarea.selectionStart;
                const end = this.textarea.selectionEnd;
                const text = this.textarea.value;
                const lines = text.split('\n');
                const lineStart = text.lastIndexOf('\n', start - 1) + 1;
                const lineEnd = text.indexOf('\n', end) === -1 ? text.length : text.indexOf('\n', end);
                const lineText = text.substring(lineStart, lineEnd);
                this.textarea.setRangeText(lineText + '\n' + lineText, lineStart, lineEnd);
                this.history.push(this.textarea.value);
                this.updateStatus();
                this.applySyntaxHighlight();
                this.updateLineNumbers();
            }

            deleteLine() {
                const start = this.textarea.selectionStart;
                const end = this.textarea.selectionEnd;
                const text = this.textarea.value;
                const lineStart = text.lastIndexOf('\n', start - 1) + 1;
                const lineEnd = text.indexOf('\n', end) === -1 ? text.length : text.indexOf('\n', end) + 1;
                this.textarea.setRangeText('', lineStart, lineEnd);
                this.history.push(this.textarea.value);
                this.updateStatus();
                this.applySyntaxHighlight();
                this.updateLineNumbers();
            }

            toggleWordWrap() {
                this.settings.wordWrap = !this.settings.wordWrap;
                document.getElementById('word-wrap').checked = this.settings.wordWrap;
                this.applySettings();
                this.saveSettings();
            }

            toggleFullScreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }

            zoom(factor) {
                this.settings.fontSize = Math.max(8, Math.min(72, this.settings.fontSize + factor));
                document.getElementById('font-size').value = this.settings.fontSize;
                document.documentElement.style.setProperty('--font-size', `${this.settings.fontSize}px`);
                this.applySettings();
                this.saveSettings();
            }

            resetZoom() {
                this.settings.fontSize = 14;
                document.getElementById('font-size').value = this.settings.fontSize;
                document.documentElement.style.setProperty('--font-size', `${this.settings.fontSize}px`);
                this.applySettings();
                this.saveSettings();
            }

            toggleLineNumbers() {
                this.settings.lineNumbers = !this.settings.lineNumbers;
                document.getElementById('line-numbers').checked = this.settings.lineNumbers;
                this.applySettings();
                this.saveSettings();
            }

            toggleMinimap() {
                this.settings.minimap = !this.settings.minimap;
                document.getElementById('minimap').checked = this.settings.minimap;
                alert('Minimap feature coming soon!');
                this.saveSettings();
            }

            toggleStatusBar() {
                const statusBar = document.getElementById('status-bar');
                statusBar.style.display = statusBar.style.display === 'none' ? 'flex' : 'none';
            }

            splitView(direction) {
                alert(`Split view (${direction}) feature coming soon!`);
            }

            removeSplit() {
                alert('Remove split feature coming soon!');
            }

            showStats() {
                const words = this.textarea.value.trim().split(/\s+/).filter(w => w).length;
                const chars = this.textarea.value.length;
                const lines = this.textarea.value.split('\n').length;
                alert(`Words: ${words}\nCharacters: ${chars}\nLines: ${lines}`);
            }

            showWordCount() {
                const words = this.textarea.value.trim().split(/\s+/).filter(w => w).length;
                alert(`Word Count: ${words}`);
            }

            toggleSpellCheck() {
                this.textarea.spellcheck = !this.textarea.spellcheck;
            }

            formatCode() {
                const lines = this.textarea.value.split('\n');
                this.textarea.value = lines.map(line => line.trim()).join('\n');
                this.history.push(this.textarea.value);
                this.applySyntaxHighlight();
                this.updateLineNumbers();
            }

            toUpperCase() {
                const start = this.textarea.selectionStart;
                const end = this.textarea.selectionEnd;
                const selectedText = this.textarea.value.substring(start, end);
                this.textarea.setRangeText(selectedText.toUpperCase());
                this.history.push(this.textarea.value);
                this.updateStatus();
            }

            toLowerCase() {
                const start = this.textarea.selectionStart;
                const end = this.textarea.selectionEnd;
                const selectedText = this.textarea.value.substring(start, end);
                this.textarea.setRangeText(selectedText.toLowerCase());
                this.history.push(this.textarea.value);
                this.updateStatus();
            }

            trimWhitespace() {
                this.textarea.value = this.textarea.value.trim();
                this.history.push(this.textarea.value);
                this.updateStatus();
                this.applySyntaxHighlight();
                this.updateLineNumbers();
            }

            tabsToSpaces() {
                this.textarea.value = this.textarea.value.replace(/\t/g, ' '.repeat(this.settings.tabSize));
                this.history.push(this.textarea.value);
                this.updateStatus();
                this.applySyntaxHighlight();
                this.updateLineNumbers();
            }

            runCode() {
                try {
                    const result = eval(this.textarea.value);
                    console.log(result);
                    alert('Code executed - check console');
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            }

            insertDate() {
                const date = new Date().toLocaleDateString();
                this.textarea.setRangeText(date);
                this.history.push(this.textarea.value);
                this.updateStatus();
            }

            insertTime() {
                const time = new Date().toLocaleTimeString();
                this.textarea.setRangeText(time);
                this.history.push(this.textarea.value);
                this.updateStatus();
            }

            insertDateTime() {
                const dateTime = new Date().toLocaleString();
                this.textarea.setRangeText(dateTime);
                this.history.push(this.textarea.value);
                this.updateStatus();
            }

            insertLoremIpsum() {
                const lorem = "Lorem ipsum dolor sit amet, consectetur adipiscing elit.";
                this.textarea.setRangeText(lorem);
                this.history.push(this.textarea.value);
                this.updateStatus();
            }

            insertHorizontalLine() {
                this.textarea.setRangeText('-'.repeat(50) + '\n');
                this.history.push(this.textarea.value);
                this.updateStatus();
            }

            insertSpecialChar(char) {
                this.textarea.setRangeText(char);
                this.history.push(this.textarea.value);
                this.updateStatus();
            }

            showCharMap() {
                alert('Character map feature coming soon!');
            }

            showCalculator() {
                alert('Calculator feature coming soon!');
            }

            previewMarkdown() {
                const html = this.convertMarkdownToHTML(this.textarea.value);
                const preview = window.open('', '_blank');
                preview.document.write(`<html><body>${html}</body></html>`);
                preview.document.close();
            }

            convertMarkdownToHTML(text) {
                return text
                    .replace(/^# (.*)$/gm, '<h1>$1</h1>')
                    .replace(/^## (.*)$/gm, '<h2>$1</h2>')
                    .replace(/\*\*(.*)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>');
            }

            showShortcuts() {
                const shortcuts = Object.values(this.menus).flat(Infinity)
                    .filter(item => item.shortcut)
                    .map(item => `${item.text}: ${item.shortcut}`)
                    .join('\n');
                alert('Keyboard Shortcuts:\n' + shortcuts);
            }

            checkUpdates() {
                alert('Checking for updates... (Simulated)');
            }

            reportBug() {
                window.open('mailto:support@example.com?subject=Wordnote Bug Report');
            }

            showAbout() {
                alert('Wordnote Pro Enhanced\nVersion 4.0\nYour Ultimate Text Editor\nCreated with ❤️');
            }

            togglePanel() {
                this.panel.classList.toggle('active');
            }

            closeEditor() {
                if (confirm('Are you sure you want to close the editor?')) {
                    window.close();
                }
            }

            resetSettings() {
                if (confirm('Reset all settings to default?')) {
                    this.settings = {
                        fontFamily: 'JetBrains Mono',
                        fontSize: 14,
                        theme: 'light',
                        syntaxHighlight: false,
                        autoSave: false,
                        lineNumbers: false,
                        wordWrap: false,
                        minimap: false,
                        languageMode: 'plaintext',
                        tabSize: 4,
                        textColor: '#333333',
                        bgColor: '#f5f6f5'
                    };
                    document.documentElement.style.setProperty('--font-size', `${this.settings.fontSize}px`);
                    this.updateSettingsUI();
                    this.applySettings();
                    localStorage.removeItem('wordnoteSettings');
                    alert('Settings reset to default');
                }
            }

            saveSettings() {
                localStorage.setItem('wordnoteSettings', JSON.stringify(this.settings));
            }

            loadSettings() {
                const saved = localStorage.getItem('wordnoteSettings');
                if (saved) {
                    this.settings = JSON.parse(saved);
                    document.documentElement.style.setProperty('--font-size', `${this.settings.fontSize}px`);
                    this.updateSettingsUI();
                }
            }

            updateSettingsUI() {
                document.getElementById('font-family').value = this.settings.fontFamily;
                document.getElementById('font-size').value = this.settings.fontSize;
                document.getElementById('theme').value = this.settings.theme;
                document.getElementById('syntax-highlight').checked = this.settings.syntaxHighlight;
                document.getElementById('auto-save').checked = this.settings.autoSave;
                document.getElementById('line-numbers').checked = this.settings.lineNumbers;
                document.getElementById('word-wrap').checked = this.settings.wordWrap;
                document.getElementById('minimap').checked = this.settings.minimap;
                document.getElementById('language-mode').value = this.settings.languageMode;
                document.getElementById('tab-size').value = this.settings.tabSize;
                document.getElementById('text-color').value = this.settings.textColor;
                document.getElementById('bg-color').value = this.settings.bgColor;
            }

            handleInput() {
                this.history.push(this.textarea.value);
                if (this.history.length > 50) this.history.shift();
                this.redoStack = [];
                this.updateStatus();
                this.applySyntaxHighlight();
                this.updateLineNumbers();
            }

            handleKeydown(e) {
                if (e.ctrlKey) {
                    switch (e.key) {
                        case 's': e.preventDefault(); this.saveFile(); break;
                        case 'o': e.preventDefault(); this.openFile(); break;
                        case 'n': e.preventDefault(); this.newDocument(); break;
                        case 'f': e.preventDefault(); this.showSearchReplace(); break;
                        case 'g': e.preventDefault(); this.goToLine(); break;
                        case 'z': e.preventDefault(); this.undo(); break;
                        case 'y': e.preventDefault(); this.redo(); break;
                        case '+': e.preventDefault(); this.zoom(2); break;
                        case '-': e.preventDefault(); this.zoom(-2); break;
                        case '0': e.preventDefault(); this.resetZoom(); break;
                        case 'a': e.preventDefault(); this.selectAll(); break;
                        case 'd': 
                            if (e.shiftKey) {
                                e.preventDefault(); 
                                this.deleteLine();
                            } else {
                                e.preventDefault(); 
                                this.duplicateLine();
                            }
                            break;
                        case 'p': e.preventDefault(); this.printText(); break;
                    }
                } else if (e.key === 'F11') {
                    e.preventDefault();
                    this.toggleFullScreen();
                } else if (e.key === 'Tab') {
                    e.preventDefault();
                    this.textarea.setRangeText(' '.repeat(this.settings.tabSize));
                    this.history.push(this.textarea.value);
                    this.updateStatus();
                }
                this.updateStatus();
            }

            updateStatus() {
                const text = this.textarea.value || '';
                const lines = text.split('\n');
                const cursorPos = this.textarea.selectionStart;
                const words = text.trim().split(/\s+/).filter(w => w).length;
                const chars = text.length;
                let line = 1;
                let col = 1;

                for (let i = 0; i < cursorPos; i++) {
                    if (text[i] === '\n') {
                        line++;
                        col = 1;
                    } else {
                        col++;
                    }
                }

                document.getElementById('cursor-pos').textContent = `Ln ${line}, Col ${col}`;
                document.getElementById('doc-stats').textContent = `Words: ${words} | Chars: ${chars}`;
                document.getElementById('lang-mode').textContent = this.settings.languageMode.charAt(0).toUpperCase() + this.settings.languageMode.slice(1);
            }

            applySettings() {
                this.textarea.style.fontFamily = this.settings.fontFamily;
                this.textarea.style.fontSize = `${this.settings.fontSize}px`;
                this.textarea.style.color = this.settings.textColor;
                this.textarea.style.backgroundColor = this.settings.bgColor;
                this.textarea.style.whiteSpace = this.settings.wordWrap ? 'pre-wrap' : 'pre';
                this.highlightLayer.style.fontFamily = this.settings.fontFamily;
                this.highlightLayer.style.fontSize = `${this.settings.fontSize}px`;
                this.highlightLayer.style.color = this.settings.textColor;
                this.highlightLayer.style.backgroundColor = this.settings.bgColor;
                this.highlightLayer.style.whiteSpace = this.settings.wordWrap ? 'pre-wrap' : 'pre';
                this.lineNumberContainer.style.fontFamily = this.settings.fontFamily;
                this.lineNumberContainer.style.fontSize = `${this.settings.fontSize}px`;
                this.applyTheme();
                this.updateLineNumbers();
                if (this.settings.syntaxHighlight) {
                    this.applySyntaxHighlight();
                } else {
                    this.highlightLayer.innerHTML = '';
                    this.textarea.style.color = this.settings.textColor;
                }
            }

            applyTheme() {
                const themes = {
                    light: {
                        '--bg-color': this.settings.bgColor,
                        '--text-color': this.settings.textColor,
                        '--menu-bg': 'linear-gradient(135deg, #ffffff, #f0f0f0)',
                        '--menu-text': '#1a1a1a',
                        '--dropdown-bg': '#ffffff',
                        '--dropdown-text': '#1a1a1a',
                        '--textarea-bg': '#ffffff',
                        '--status-bg': '#fafafa',
                        '--status-color': '#555555',
                        '--panel-bg': '#ffffff',
                        '--input-bg': '#f9f9f9',
                        '--border-color': '#d0d0d0',
                        '--hover-bg': 'rgba(0,120,212,0.1)',
                        '--active-bg': 'rgba(0,120,212,0.2)'
                    },
                    dark: {
                        '--bg-color': this.settings.bgColor,
                        '--text-color': this.settings.textColor,
                        '--menu-bg': 'linear-gradient(135deg, #2d2d2d, #252525)',
                        '--menu-text': '#e0e0e0',
                        '--dropdown-bg': '#2d2d2d',
                        '--dropdown-text': '#e0e0e0',
                        '--textarea-bg': '#252525',
                        '--status-bg': '#2d2d2d',
                        '--status-color': '#b0b0b0',
                        '--panel-bg': '#2d2d2d',
                        '--input-bg': '#333333',
                        '--border-color': '#404040',
                        '--hover-bg': 'rgba(0,120,212,0.2)',
                        '--active-bg': 'rgba(0,120,212,0.3)'
                    },
                    // ... (other themes remain unchanged)
                };

                Object.entries(themes[this.settings.theme] || themes.light).forEach(([key, value]) => {
                    document.documentElement.style.setProperty(key, value);
                });
            }

            applySyntaxHighlight() {
                if (!this.settings.syntaxHighlight) {
                    this.highlightLayer.innerHTML = '';
                    this.textarea.style.color = this.settings.textColor;
                    return;
                }

                const languageRules = {
                    javascript: {
                        keywords: ['function', 'const', 'let', 'var', 'if', 'else', 'return', 'for', 'while', 'class', 'this'],
                        keywordColor: '#0078d4',
                        stringColor: '#e6c07b',
                        commentColor: '#6a737d',
                        numberColor: '#d19a66'
                    },
                    python: {
                        keywords: ['def', 'class', 'if', 'else', 'elif', 'for', 'while', 'return', 'import', 'from'],
                        keywordColor: '#3572A5',
                        stringColor: '#e6db74',
                        commentColor: '#75715e',
                        numberColor: '#d19a66'
                    },
                    html: {
                        keywords: ['<!DOCTYPE', '<html', '<head', '<body', '<div', '<span'],
                        keywordColor: '#e34c26',
                        stringColor: '#032f62',
                        commentColor: '#969896',
                        numberColor: '#d19a66'
                    }
                };

                const rules = languageRules[this.settings.languageMode] || languageRules.javascript;
                const keywords = rules.keywords;
                const strings = /(["'`])(?:(?=(\\?))\2.)*?\1/g;
                const comments = /(\/\/.*$|\/\*[\s\S]*?\*\/)/gm;
                const numbers = /\b\d+\b/g;

                let content = this.textarea.value
                    .replace(/&/g, '&')
                    .replace(/</g, '<')
                    .replace(/>/g, '>');

                content = content
                    .replace(comments, match => `<span style="color: ${rules.commentColor}">${match}</span>`)
                    .replace(strings, match => `<span style="color: ${rules.stringColor}">${match}</span>`)
                    .replace(numbers, match => `<span style="color: ${rules.numberColor}">${match}</span>`)
                    .replace(new RegExp(`\\b(${keywords.join('|')})\\b`, 'g'), 
                        match => `<span style="color: ${rules.keywordColor}">${match}</span>`);

                this.highlightLayer.innerHTML = content;
                this.textarea.style.color = 'transparent';
                this.textarea.style.caretColor = this.settings.textColor;
            }

            detectLanguage(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const extMap = {
                    'js': 'javascript',
                    'py': 'python',
                    'html': 'html',
                    'css': 'css',
                    'md': 'markdown',
                    'txt': 'plaintext'
                };
                this.settings.languageMode = extMap[ext] || 'plaintext';
                document.getElementById('language-mode').value = this.settings.languageMode;
                this.applySettings();
                this.saveSettings();
            }

            addToRecentFiles(filename) {
                const recentMenu = this.menus.file.find(item => item.text === 'Recent Files').submenu;
                recentMenu.unshift({ text: filename, action: () => this.openRecentFile(filename) });
                if (recentMenu.length > 5) recentMenu.pop();
                if (recentMenu[recentMenu.length - 1].text === 'No recent files') recentMenu.pop();
            }

            openRecentFile(filename) {
                alert(`Opening recent file: ${filename} (Functionality to be implemented)`);
            }

            hexToRgb(hex) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `${r}, ${g}, ${b}`;
            }

            updateLineNumbers() {
                const screenWidth = window.innerWidth;
                if (!this.settings.lineNumbers || screenWidth <= 768) {
                    this.lineNumberContainer.style.display = 'none';
                    this.highlightLayer.style.left = 'var(--screen-gap)';
                    this.textarea.style.marginLeft = 'var(--screen-gap)';
                    return;
                }

                this.lineNumberContainer.style.display = 'block';
                this.highlightLayer.style.left = 'clamp(30px, 5vw, 40px)';
                this.textarea.style.marginLeft = '0';
                const lines = this.textarea.value.split('\n');
                this.lineNumberContainer.innerHTML = Array.from(
                    { length: lines.length },
                    (_, i) => `<div style="line-height: ${this.settings.fontSize * 1.5}px">${i + 1}</div>`
                ).join('');
            }

            syncLineNumbersScroll() {
                this.lineNumberContainer.scrollTop = this.textarea.scrollTop;
                this.highlightLayer.scrollTop = this.textarea.scrollTop;
            }
        }

        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        script.onload = () => {
            const editor = new WordnotePro();
        };
        document.head.appendChild(script);
    </script>
</body>
</html>